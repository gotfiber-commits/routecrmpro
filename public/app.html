<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RouteCRMPro</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.development.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.development.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://js.stripe.com/v3/"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDlnoisXs3xJAGtyYCBmLRCSuSN0hI2v98&libraries=places,geometry"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #6366F1; --primary-dark: #4F46E5; --secondary: #8B5CF6; --accent: #F59E0B;
            --success: #10B981; --danger: #EF4444; --warning: #F59E0B;
            --bg-dark: #0F172A; --bg-card: #1E293B; --bg-hover: #334155;
            --text-primary: #F8FAFC; --text-secondary: #94A3B8; --text-muted: #64748B; --border: #334155;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Outfit', sans-serif; background: var(--bg-dark); color: var(--text-primary); line-height: 1.6; }
        
        /* Login */
        .login-container { min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 2rem; background: linear-gradient(135deg, var(--bg-dark) 0%, #1a1a2e 100%); }
        .login-box { background: var(--bg-card); padding: 2.5rem; border-radius: 16px; width: 100%; max-width: 420px; box-shadow: 0 25px 50px rgba(0,0,0,0.3); }
        .login-header { text-align: center; margin-bottom: 2rem; }
        .login-header h1 { font-size: 2rem; background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .company-badge { display: inline-block; background: var(--bg-hover); padding: 0.5rem 1rem; border-radius: 20px; margin-top: 0.75rem; font-size: 0.9rem; color: var(--text-secondary); }
        
        /* Forms */
        .form-group { margin-bottom: 1rem; }
        .form-label { display: block; margin-bottom: 0.5rem; color: var(--text-secondary); font-weight: 500; font-size: 0.9rem; }
        .form-input, .form-select { width: 100%; padding: 0.75rem 1rem; background: var(--bg-dark); border: 2px solid var(--border); border-radius: 8px; color: var(--text-primary); font-size: 1rem; font-family: inherit; }
        .form-input:focus, .form-select:focus { outline: none; border-color: var(--primary); }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        .form-row-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; }
        
        /* Buttons */
        .btn { padding: 0.75rem 1.5rem; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-family: inherit; font-size: 0.95rem; transition: all 0.2s; display: inline-flex; align-items: center; gap: 0.5rem; }
        .btn-primary { background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); color: white; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4); }
        .btn-secondary { background: var(--bg-hover); color: var(--text-primary); border: 1px solid var(--border); }
        .btn-danger { background: var(--danger); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-sm { padding: 0.4rem 0.75rem; font-size: 0.85rem; }
        .btn-block { width: 100%; justify-content: center; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        
        /* Layout */
        .dashboard { display: flex; min-height: 100vh; }
        .sidebar { width: 250px; background: var(--bg-card); border-right: 1px solid var(--border); display: flex; flex-direction: column; position: fixed; height: 100vh; overflow-y: auto; z-index: 100; }
        .sidebar-header { padding: 1.25rem; border-bottom: 1px solid var(--border); }
        .sidebar-logo { display: flex; align-items: center; gap: 0.75rem; }
        .sidebar-logo-icon { width: 40px; height: 40px; background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.25rem; }
        .sidebar-logo h2 { font-size: 1rem; }
        .company-name { font-size: 0.8rem; color: var(--text-muted); }
        .sidebar-nav { flex: 1; padding: 1rem 0; }
        .nav-item { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 1.25rem; color: var(--text-secondary); cursor: pointer; transition: all 0.2s; border-left: 3px solid transparent; }
        .nav-item:hover { background: var(--bg-hover); color: var(--text-primary); }
        .nav-item.active { background: rgba(99, 102, 241, 0.1); color: var(--primary); border-left-color: var(--primary); }
        .sidebar-footer { padding: 1rem; border-top: 1px solid var(--border); }
        .user-info { display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1rem; }
        .user-avatar { width: 36px; height: 36px; background: var(--bg-hover); border-radius: 50%; display: flex; align-items: center; justify-content: center; }
        .user-name { font-weight: 600; font-size: 0.9rem; }
        .user-role { font-size: 0.75rem; color: var(--text-muted); text-transform: capitalize; }
        .main-content { flex: 1; margin-left: 250px; padding: 1.5rem; min-height: 100vh; }
        
        /* Cards & Tables */
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 1rem; }
        .page-title { font-size: 1.5rem; font-weight: 700; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1rem; margin-bottom: 1.5rem; }
        .stat-card { background: var(--bg-card); border-radius: 12px; padding: 1.25rem; border: 1px solid var(--border); }
        .stat-card-icon { font-size: 1.5rem; margin-bottom: 0.5rem; }
        .stat-card-value { font-size: 1.75rem; font-weight: 700; }
        .stat-card-label { font-size: 0.85rem; color: var(--text-muted); }
        .card { background: var(--bg-card); border-radius: 12px; border: 1px solid var(--border); margin-bottom: 1.5rem; }
        .card-header { padding: 1rem 1.25rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .card-header h3 { font-size: 1rem; font-weight: 600; }
        .card-body { padding: 1.25rem; }
        .table-container { background: var(--bg-card); border-radius: 12px; border: 1px solid var(--border); overflow: hidden; }
        .table-header { padding: 1rem 1.25rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; }
        .table-title { font-weight: 600; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 0.75rem 1rem; text-align: left; border-bottom: 1px solid var(--border); }
        th { background: var(--bg-dark); font-weight: 600; font-size: 0.85rem; color: var(--text-secondary); }
        tr:hover { background: var(--bg-hover); }
        tr:last-child td { border-bottom: none; }
        .status-badge { padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.75rem; font-weight: 600; text-transform: capitalize; }
        .status-active, .status-paid, .status-completed, .status-delivered { background: rgba(16, 185, 129, 0.2); color: var(--success); }
        .status-pending, .status-planned, .status-scheduled, .status-available { background: rgba(245, 158, 11, 0.2); color: var(--warning); }
        .status-inactive, .status-cancelled, .status-overdue, .status-maintenance { background: rgba(239, 68, 68, 0.2); color: var(--danger); }
        .status-in_progress, .status-on_route { background: rgba(99, 102, 241, 0.2); color: var(--primary); }
        
        /* Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 1000; padding: 1rem; }
        .modal { background: var(--bg-card); border-radius: 16px; width: 100%; max-width: 600px; max-height: 90vh; overflow-y: auto; }
        .modal-header { padding: 1.25rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; background: var(--bg-card); z-index: 1; }
        .modal-header h3 { font-size: 1.1rem; }
        .modal-close { background: none; border: none; font-size: 1.5rem; color: var(--text-muted); cursor: pointer; }
        .modal-body { padding: 1.25rem; }
        .modal-footer { padding: 1rem 1.25rem; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 0.75rem; position: sticky; bottom: 0; background: var(--bg-card); }
        
        /* Map */
        .map-container { height: 400px; border-radius: 12px; overflow: hidden; border: 1px solid var(--border); }
        #dashboard-map, #route-map { height: 100%; width: 100%; }
        
        /* Misc */
        .loading { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 4rem; }
        .spinner { width: 40px; height: 40px; border: 3px solid var(--border); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .error-message { background: rgba(239, 68, 68, 0.1); border: 1px solid var(--danger); color: var(--danger); padding: 0.75rem; border-radius: 8px; margin-bottom: 1rem; }
        .success-message { background: rgba(16, 185, 129, 0.1); border: 1px solid var(--success); color: var(--success); padding: 0.75rem; border-radius: 8px; margin-bottom: 1rem; }
        .empty-state { text-align: center; padding: 3rem; color: var(--text-muted); }
        .action-buttons { display: flex; gap: 0.5rem; }
        .text-muted { color: var(--text-muted); }
        .text-success { color: var(--success); }
        .text-danger { color: var(--danger); }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; }
        
        @media (max-width: 768px) {
            .sidebar { width: 100%; position: relative; height: auto; }
            .main-content { margin-left: 0; }
            .form-row, .form-row-3, .grid-2 { grid-template-columns: 1fr; }
            .stats-grid { grid-template-columns: 1fr 1fr; }
            .table-container { overflow-x: auto; }
        }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // =====================================================
        // API Helper
        // =====================================================
        const api = {
            token: null,
            tenant: null,
            setToken(t) { this.token = t; if (t) localStorage.setItem('token', t); else localStorage.removeItem('token'); },
            setTenant(t) { this.tenant = t; },
            async request(endpoint, options = {}) {
                const url = `/.netlify/functions${endpoint}${endpoint.includes('?') ? '&' : '?'}tenant=${this.tenant}`;
                const res = await fetch(url, {
                    ...options,
                    headers: {
                        'Content-Type': 'application/json',
                        ...(this.token && { 'Authorization': `Bearer ${this.token}` }),
                        ...options.headers
                    }
                });
                const data = await res.json();
                if (!res.ok) throw new Error(data.error || 'Request failed');
                return data;
            }
        };

        const getTenant = () => new URLSearchParams(window.location.search).get('tenant') || '';

        // =====================================================
        // Login Screen
        // =====================================================
        function LoginScreen({ onLogin, tenant }) {
            const [username, setUsername] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);

            const handleSubmit = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError('');
                try {
                    const data = await api.request('/auth/login', {
                        method: 'POST',
                        body: JSON.stringify({ username, password })
                    });
                    api.setToken(data.token);
                    onLogin(data);
                } catch (err) {
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            };

            if (!tenant) {
                return (
                    <div className="login-container">
                        <div className="login-box" style={{ textAlign: 'center' }}>
                            <h1 style={{ marginBottom: '1rem' }}>üöõ RouteCRMPro</h1>
                            <p style={{ color: 'var(--text-muted)', marginBottom: '1.5rem' }}>No company specified</p>
                            <p style={{ color: 'var(--text-secondary)' }}>Please use the URL provided by your company:<br/><code style={{background:'var(--bg-dark)',padding:'0.25rem 0.5rem',borderRadius:'4px'}}>routecrmpro.com/app?tenant=yourcompany</code></p>
                        </div>
                    </div>
                );
            }

            return (
                <div className="login-container">
                    <div className="login-box">
                        <div className="login-header">
                            <h1>üöõ RouteCRMPro</h1>
                            <div className="company-badge">{tenant}</div>
                        </div>
                        {error && <div className="error-message">{error}</div>}
                        <form onSubmit={handleSubmit}>
                            <div className="form-group">
                                <label className="form-label">Username</label>
                                <input type="text" className="form-input" value={username} onChange={(e) => setUsername(e.target.value)} required autoFocus />
                            </div>
                            <div className="form-group">
                                <label className="form-label">Password</label>
                                <input type="password" className="form-input" value={password} onChange={(e) => setPassword(e.target.value)} required />
                            </div>
                            <button type="submit" className="btn btn-primary btn-block" disabled={loading}>
                                {loading ? 'Signing in...' : 'Sign In'}
                            </button>
                        </form>
                    </div>
                </div>
            );
        }

        // =====================================================
        // Main Dashboard Component
        // =====================================================
        function MainDashboard({ user, company, onLogout }) {
            const [activeView, setActiveView] = useState('dashboard');
            const [data, setData] = useState(null);
            const [loading, setLoading] = useState(true);

            useEffect(() => { loadData(); }, []);

            const loadData = async () => {
                setLoading(true);
                try {
                    const result = await api.request('/data');
                    setData(result);
                } catch (err) {
                    console.error('Failed to load data:', err);
                } finally {
                    setLoading(false);
                }
            };

            const navItems = [
                { id: 'dashboard', icon: 'üìä', label: 'Dashboard' },
                { id: 'customers', icon: 'üë•', label: 'Customers' },
                { id: 'orders', icon: 'üì¶', label: 'Orders' },
                { id: 'route-templates', icon: 'üó∫Ô∏è', label: 'Route Templates' },
                { id: 'active-routes', icon: 'üöÄ', label: 'Active Routes' },
                { id: 'trucks', icon: 'üöö', label: 'Trucks' },
                { id: 'drivers', icon: 'üë∑', label: 'Drivers' },
                { id: 'dcs', icon: 'üè≠', label: 'Distribution Centers' },
            ];
            
            if (user?.role === 'admin') {
                navItems.push(
                    { id: 'users', icon: 'üë§', label: 'Users' },
                    { id: 'billing', icon: 'üí≥', label: 'Billing' }
                );
            }

            return (
                <div className="dashboard">
                    <div className="sidebar">
                        <div className="sidebar-header">
                            <div className="sidebar-logo">
                                <div className="sidebar-logo-icon">üöõ</div>
                                <div><h2>RouteCRMPro</h2><div className="company-name">{company?.name || 'Company'}</div></div>
                            </div>
                        </div>
                        <nav className="sidebar-nav">
                            {navItems.map(item => (
                                <div key={item.id} className={`nav-item ${activeView === item.id ? 'active' : ''}`} onClick={() => setActiveView(item.id)}>
                                    <span style={{ fontSize: '1.1rem' }}>{item.icon}</span>
                                    <span>{item.label}</span>
                                </div>
                            ))}
                        </nav>
                        <div className="sidebar-footer">
                            <div className="user-info">
                                <div className="user-avatar">{user?.avatar || 'üë§'}</div>
                                <div><div className="user-name">{user?.name || 'User'}</div><div className="user-role">{user?.role || ''}</div></div>
                            </div>
                            <button className="btn btn-secondary btn-sm btn-block" onClick={onLogout}>üö™ Sign Out</button>
                        </div>
                    </div>
                    <div className="main-content">
                        {loading ? (
                            <div className="loading"><div className="spinner"></div><div style={{marginTop:'1rem'}}>Loading...</div></div>
                        ) : (
                            <>
                                {activeView === 'dashboard' && <DashboardView data={data} onRefresh={loadData} onNavigate={(view, placeData) => { setActiveView(view); if (placeData) window.pendingRouteLocation = placeData; }} />}
                                {activeView === 'customers' && <CustomersView data={data} onRefresh={loadData} />}
                                {activeView === 'orders' && <OrdersView data={data} onRefresh={loadData} />}
                                {activeView === 'route-templates' && <RouteTemplatesView data={data} onRefresh={loadData} />}
                                {activeView === 'active-routes' && <ActiveRoutesView data={data} onRefresh={loadData} />}
                                {activeView === 'routes' && <RoutesView data={data} onRefresh={loadData} />}
                                {activeView === 'trucks' && <TrucksView data={data} onRefresh={loadData} />}
                                {activeView === 'drivers' && <DriversView data={data} onRefresh={loadData} />}
                                {activeView === 'dcs' && <DCsView data={data} onRefresh={loadData} />}
                                {activeView === 'users' && <UsersView data={data} onRefresh={loadData} />}
                                {activeView === 'billing' && <BillingView />}
                            </>
                        )}
                    </div>
                </div>
            );
        }

        // =====================================================
        // Dashboard View with Map and Places Search
        // =====================================================
        function DashboardView({ data, onRefresh, onNavigate }) {
            const mapRef = useRef(null);
            const mapInstance = useRef(null);
            const markersRef = useRef([]);
            const searchInputRef = useRef(null);
            const autocompleteRef = useRef(null);
            const searchMarkerRef = useRef(null);
            const [searchedPlace, setSearchedPlace] = useState(null);
            const [showAddModal, setShowAddModal] = useState(false);
            const [addingCustomer, setAddingCustomer] = useState(false);

            useEffect(() => {
                if (!mapRef.current || mapInstance.current) return;

                // Find company headquarters (first DC or primary DC)
                const headquarters = (data?.distributionCenters || []).find(dc => dc.is_headquarters || dc.is_primary) 
                    || (data?.distributionCenters || [])[0];
                
                const hqLat = headquarters?.lat ? parseFloat(headquarters.lat) : 39.8283;
                const hqLng = headquarters?.lng ? parseFloat(headquarters.lng) : -98.5795;
                const hasHQ = headquarters?.lat && headquarters?.lng;

                // Initialize Google Map (standard appearance)
                const map = new google.maps.Map(mapRef.current, {
                    center: { lat: hqLat, lng: hqLng },
                    zoom: hasHQ ? 8 : 4,
                    mapTypeControl: true,
                    streetViewControl: true,
                    fullscreenControl: true
                });
                mapInstance.current = map;

                // Add 500 mile radius circle around HQ
                const serviceAreaRef = { current: null };
                if (hasHQ) {
                    const radiusInMeters = 500 * 1609.34; // 500 miles to meters
                    serviceAreaRef.current = new google.maps.Circle({
                        map: map,
                        center: { lat: hqLat, lng: hqLng },
                        radius: radiusInMeters,
                        fillColor: '#6366F1',
                        fillOpacity: 0.08,
                        strokeColor: '#6366F1',
                        strokeOpacity: 0.4,
                        strokeWeight: 2
                    });
                    
                    // Fit map to show the service area circle
                    map.fitBounds(serviceAreaRef.current.getBounds());
                }

                // Initialize Places Autocomplete
                if (searchInputRef.current) {
                    const autocomplete = new google.maps.places.Autocomplete(searchInputRef.current, {
                        types: ['address'],
                        componentRestrictions: { country: 'us' },
                        fields: ['place_id', 'geometry', 'name', 'formatted_address', 'address_components']
                    });
                    autocomplete.bindTo('bounds', map);
                    autocompleteRef.current = autocomplete;

                    autocomplete.addListener('place_changed', () => {
                        const place = autocomplete.getPlace();
                        if (!place.geometry || !place.geometry.location) {
                            console.log('No geometry for place');
                            return;
                        }

                        // Parse address components
                        let street = '', city = '', state = '', zip = '';
                        (place.address_components || []).forEach(comp => {
                            if (comp.types.includes('street_number')) street = comp.long_name + ' ';
                            if (comp.types.includes('route')) street += comp.long_name;
                            if (comp.types.includes('locality')) city = comp.long_name;
                            if (comp.types.includes('administrative_area_level_1')) state = comp.short_name;
                            if (comp.types.includes('postal_code')) zip = comp.long_name;
                        });

                        const placeData = {
                            name: place.name || '',
                            formatted_address: place.formatted_address,
                            address: street.trim(),
                            city: city,
                            state: state,
                            zip: zip,
                            lat: place.geometry.location.lat(),
                            lng: place.geometry.location.lng()
                        };
                        setSearchedPlace(placeData);

                        // Clear previous search marker
                        if (searchMarkerRef.current) {
                            searchMarkerRef.current.setMap(null);
                        }

                        // Add new search marker
                        const marker = new google.maps.Marker({
                            position: place.geometry.location,
                            map: map,
                            title: place.formatted_address,
                            animation: google.maps.Animation.DROP,
                            icon: {
                                path: google.maps.SymbolPath.CIRCLE,
                                scale: 12,
                                fillColor: '#8B5CF6',
                                fillOpacity: 1,
                                strokeColor: '#ffffff',
                                strokeWeight: 3
                            }
                        });
                        searchMarkerRef.current = marker;

                        // Create info window with action buttons
                        const infoContent = document.createElement('div');
                        infoContent.innerHTML = `
                            <div style="color:#333;min-width:220px;padding:8px 0">
                                <div style="font-weight:bold;font-size:14px;margin-bottom:8px">üìç ${place.formatted_address}</div>
                                <div style="font-size:12px;color:#666;margin-bottom:12px">
                                    Lat: ${placeData.lat.toFixed(6)}<br/>
                                    Lng: ${placeData.lng.toFixed(6)}
                                </div>
                                <div style="display:flex;gap:8px">
                                    <button id="add-customer-btn" style="flex:1;padding:8px 12px;background:#6366F1;color:white;border:none;border-radius:6px;cursor:pointer;font-weight:600;font-size:12px">+ Add Customer</button>
                                    <button id="add-to-route-btn" style="flex:1;padding:8px 12px;background:#10B981;color:white;border:none;border-radius:6px;cursor:pointer;font-weight:600;font-size:12px">+ Add to Route</button>
                                </div>
                            </div>
                        `;

                        const infoWindow = new google.maps.InfoWindow({ content: infoContent });
                        infoWindow.open(map, marker);

                        // Add button click handlers after info window opens
                        google.maps.event.addListenerOnce(infoWindow, 'domready', () => {
                            document.getElementById('add-customer-btn')?.addEventListener('click', () => {
                                setShowAddModal(true);
                                infoWindow.close();
                            });
                            document.getElementById('add-to-route-btn')?.addEventListener('click', () => {
                                // Navigate to route templates - user can add customer to a template
                                if (onNavigate) {
                                    onNavigate('route-templates', placeData);
                                }
                                infoWindow.close();
                            });
                        });

                        // Pan to location
                        if (place.geometry.viewport) {
                            map.fitBounds(place.geometry.viewport);
                        } else {
                            map.setCenter(place.geometry.location);
                            map.setZoom(15);
                        }
                    });
                }

                const bounds = new google.maps.LatLngBounds();
                let hasMarkers = false;

                // DC markers (warehouse icon)
                (data?.distributionCenters || []).forEach(dc => {
                    if (dc.lat && dc.lng) {
                        const marker = new google.maps.Marker({
                            position: { lat: parseFloat(dc.lat), lng: parseFloat(dc.lng) },
                            map: map,
                            title: dc.name,
                            icon: {
                                url: 'data:image/svg+xml,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="#6366F1"><path d="M12 2L2 7v10l10 5 10-5V7L12 2zm0 2.18l6.9 3.45L12 11.09 5.1 7.63 12 4.18zM4 8.72l7 3.5v7.06l-7-3.5V8.72zm9 10.56V12.22l7-3.5v7.06l-7 3.5z"/></svg>'),
                                scaledSize: new google.maps.Size(32, 32),
                                anchor: new google.maps.Point(16, 16)
                            }
                        });
                        const infoWindow = new google.maps.InfoWindow({
                            content: `<div style="color:#333;min-width:150px"><b>üè≠ ${dc.name}</b><br/>${dc.address || ''}<br/>${dc.city || ''}, ${dc.state || ''}<br/>Capacity: ${(dc.capacity_gallons || 0).toLocaleString()} gal</div>`
                        });
                        marker.addListener('click', () => infoWindow.open(map, marker));
                        markersRef.current.push(marker);
                        bounds.extend(marker.getPosition());
                        hasMarkers = true;
                    }
                });

                // Truck markers with GPS
                (data?.trucks || []).forEach(truck => {
                    if (truck.current_lat && truck.current_lng) {
                        const marker = new google.maps.Marker({
                            position: { lat: parseFloat(truck.current_lat), lng: parseFloat(truck.current_lng) },
                            map: map,
                            title: truck.name || truck.code,
                            icon: {
                                url: 'data:image/svg+xml,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="#F59E0B"><path d="M20 8h-3V4H3c-1.1 0-2 .9-2 2v11h2c0 1.66 1.34 3 3 3s3-1.34 3-3h6c0 1.66 1.34 3 3 3s3-1.34 3-3h2v-5l-3-4zM6 18.5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm13.5-9l1.96 2.5H17V9.5h2.5zm-1.5 9c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"/></svg>'),
                                scaledSize: new google.maps.Size(28, 28),
                                anchor: new google.maps.Point(14, 14)
                            }
                        });
                        const infoWindow = new google.maps.InfoWindow({
                            content: `<div style="color:#333"><b>üöö ${truck.name || truck.code}</b><br/>Status: ${truck.status}<br/>Speed: ${truck.speed || 0} mph</div>`
                        });
                        marker.addListener('click', () => infoWindow.open(map, marker));
                        markersRef.current.push(marker);
                        bounds.extend(marker.getPosition());
                        hasMarkers = true;
                    }
                });

                // Customer markers
                (data?.customers || []).slice(0, 100).forEach(cust => {
                    if (cust.lat && cust.lng) {
                        const color = cust.current_level < 25 ? '#EF4444' : cust.current_level < 50 ? '#F59E0B' : '#10B981';
                        const marker = new google.maps.Marker({
                            position: { lat: parseFloat(cust.lat), lng: parseFloat(cust.lng) },
                            map: map,
                            title: cust.name,
                            icon: {
                                path: google.maps.SymbolPath.CIRCLE,
                                scale: 8,
                                fillColor: color,
                                fillOpacity: 1,
                                strokeColor: '#ffffff',
                                strokeWeight: 2
                            }
                        });
                        const infoWindow = new google.maps.InfoWindow({
                            content: `<div style="color:#333"><b>${cust.name}</b><br/>${cust.address || ''}<br/>${cust.city || ''}, ${cust.state || ''}<br/>Tank: ${cust.current_level || 0}%</div>`
                        });
                        marker.addListener('click', () => infoWindow.open(map, marker));
                        markersRef.current.push(marker);
                        bounds.extend(marker.getPosition());
                        hasMarkers = true;
                    }
                });

                if (hasMarkers) {
                    map.fitBounds(bounds);
                    // Limit max zoom after fitBounds
                    google.maps.event.addListenerOnce(map, 'bounds_changed', () => {
                        if (map.getZoom() > 12) map.setZoom(12);
                    });
                }

                return () => {
                    markersRef.current.forEach(m => m.setMap(null));
                    markersRef.current = [];
                    if (searchMarkerRef.current) searchMarkerRef.current.setMap(null);
                    mapInstance.current = null;
                };
            }, [data]);

            // Handle quick add customer from map search
            const handleQuickAddCustomer = async () => {
                if (!searchedPlace) return;
                setAddingCustomer(true);
                try {
                    const customerData = {
                        code: 'CUST-' + Date.now().toString().slice(-6),
                        name: searchedPlace.name || 'New Customer',
                        address: searchedPlace.address,
                        city: searchedPlace.city,
                        state: searchedPlace.state,
                        zip: searchedPlace.zip,
                        lat: searchedPlace.lat,
                        lng: searchedPlace.lng,
                        status: 'active',
                        customer_type: 'residential',
                        tank_size: 500,
                        current_level: 50,
                        price_per_gallon: 2.50,
                        payment_terms: 'net30'
                    };
                    await api.request('/data/customers', { method: 'POST', body: JSON.stringify(customerData) });
                    setShowAddModal(false);
                    setSearchedPlace(null);
                    if (searchMarkerRef.current) searchMarkerRef.current.setMap(null);
                    if (searchInputRef.current) searchInputRef.current.value = '';
                    if (onRefresh) onRefresh();
                } catch (err) {
                    alert('Error adding customer: ' + err.message);
                } finally {
                    setAddingCustomer(false);
                }
            };

            const pendingOrders = (data?.orders || []).filter(o => o.status === 'pending').length;
            const [activeRuns, setActiveRuns] = useState(0);
            const [routeTemplates, setRouteTemplates] = useState(0);
            const activeTrucks = (data?.trucks || []).filter(t => t.status === 'active').length;
            const lowTankCustomers = (data?.customers || []).filter(c => c.current_level < 25).length;

            // Load route stats
            useEffect(() => {
                const loadRouteStats = async () => {
                    try {
                        const [runsResult, templatesResult] = await Promise.all([
                            api.request('/routes-v2/runs?status=in_progress'),
                            api.request('/routes-v2/templates')
                        ]);
                        setActiveRuns(runsResult?.length || 0);
                        setRouteTemplates(templatesResult?.length || 0);
                    } catch (err) {
                        console.log('Could not load route stats:', err.message);
                    }
                };
                loadRouteStats();
            }, []);

            return (
                <>
                    <div className="page-header"><h1 className="page-title">üìä Dashboard</h1></div>
                    
                    <div className="stats-grid">
                        <div className="stat-card">
                            <div className="stat-card-icon">üë•</div>
                            <div className="stat-card-value">{data?.customers?.length || 0}</div>
                            <div className="stat-card-label">Total Customers</div>
                        </div>
                        <div className="stat-card">
                            <div className="stat-card-icon">üì¶</div>
                            <div className="stat-card-value">{pendingOrders}</div>
                            <div className="stat-card-label">Pending Orders</div>
                        </div>
                        <div className="stat-card" style={{cursor:'pointer'}} onClick={() => onNavigate('active-routes')}>
                            <div className="stat-card-icon">üöÄ</div>
                            <div className="stat-card-value">{activeRuns}</div>
                            <div className="stat-card-label">Active Routes</div>
                        </div>
                        <div className="stat-card" style={{cursor:'pointer'}} onClick={() => onNavigate('route-templates')}>
                            <div className="stat-card-icon">üó∫Ô∏è</div>
                            <div className="stat-card-value">{routeTemplates}</div>
                            <div className="stat-card-label">Route Templates</div>
                        </div>
                        <div className="stat-card">
                            <div className="stat-card-icon">üöö</div>
                            <div className="stat-card-value">{activeTrucks}</div>
                            <div className="stat-card-label">Active Trucks</div>
                        </div>
                        <div className="stat-card" style={{borderColor: lowTankCustomers > 0 ? 'var(--danger)' : 'var(--border)'}}>
                            <div className="stat-card-icon">‚ö†Ô∏è</div>
                            <div className="stat-card-value" style={{color: lowTankCustomers > 0 ? 'var(--danger)' : 'inherit'}}>{lowTankCustomers}</div>
                            <div className="stat-card-label">Low Tank Alerts</div>
                        </div>
                    </div>

                    {/* Map with Search */}
                    <div className="card">
                        <div className="card-header" style={{flexWrap:'wrap',gap:'1rem'}}>
                            <h3>üó∫Ô∏è Operations Map</h3>
                            <div style={{display:'flex',alignItems:'center',gap:'1rem',flex:'1',justifyContent:'flex-end',flexWrap:'wrap'}}>
                                <div style={{position:'relative',flex:'1',maxWidth:'400px',minWidth:'200px'}}>
                                    <input 
                                        ref={searchInputRef}
                                        type="text" 
                                        placeholder="üîç Search address to add..." 
                                        className="form-input"
                                        style={{paddingRight:'2.5rem',fontSize:'0.9rem'}}
                                    />
                                    {searchedPlace && (
                                        <button 
                                            onClick={() => {
                                                setSearchedPlace(null);
                                                if (searchMarkerRef.current) searchMarkerRef.current.setMap(null);
                                                if (searchInputRef.current) searchInputRef.current.value = '';
                                            }}
                                            style={{position:'absolute',right:'8px',top:'50%',transform:'translateY(-50%)',background:'none',border:'none',cursor:'pointer',fontSize:'1.2rem',color:'var(--text-muted)'}}
                                        >√ó</button>
                                    )}
                                </div>
                                <div style={{fontSize:'0.75rem',color:'var(--text-muted)',display:'flex',gap:'0.75rem',flexWrap:'wrap'}}>
                                    <span>üè≠ DCs</span>
                                    <span>üöö Trucks</span>
                                    <span style={{display:'flex',alignItems:'center',gap:'3px'}}><span style={{width:'8px',height:'8px',borderRadius:'50%',background:'#10B981'}}></span>OK</span>
                                    <span style={{display:'flex',alignItems:'center',gap:'3px'}}><span style={{width:'8px',height:'8px',borderRadius:'50%',background:'#F59E0B'}}></span>Low</span>
                                    <span style={{display:'flex',alignItems:'center',gap:'3px'}}><span style={{width:'8px',height:'8px',borderRadius:'50%',background:'#EF4444'}}></span>Critical</span>
                                    <span style={{display:'flex',alignItems:'center',gap:'3px'}}><span style={{width:'8px',height:'8px',borderRadius:'50%',background:'#8B5CF6'}}></span>Search</span>
                                </div>
                            </div>
                        </div>
                        <div className="map-container" style={{height:'450px'}}>
                            <div ref={mapRef} id="dashboard-map"></div>
                        </div>
                        {searchedPlace && (
                            <div style={{padding:'1rem',background:'var(--bg-dark)',borderTop:'1px solid var(--border)',display:'flex',alignItems:'center',justifyContent:'space-between',flexWrap:'wrap',gap:'1rem'}}>
                                <div>
                                    <strong style={{color:'#8B5CF6'}}>üìç {searchedPlace.formatted_address}</strong>
                                    <div style={{fontSize:'0.85rem',color:'var(--text-muted)',marginTop:'0.25rem'}}>
                                        Coordinates: {searchedPlace.lat.toFixed(6)}, {searchedPlace.lng.toFixed(6)}
                                    </div>
                                </div>
                                <div style={{display:'flex',gap:'0.5rem'}}>
                                    <button className="btn btn-primary btn-sm" onClick={() => setShowAddModal(true)}>+ Add as Customer</button>
                                    <button className="btn btn-success btn-sm" onClick={() => onNavigate && onNavigate('routes', searchedPlace)}>+ Add to Route</button>
                                </div>
                            </div>
                        )}
                    </div>

                    {/* Quick Add Customer Modal */}
                    {showAddModal && searchedPlace && (
                        <div className="modal-overlay" onClick={(e) => e.target === e.currentTarget && setShowAddModal(false)}>
                            <div className="modal" style={{maxWidth:'500px'}}>
                                <div className="modal-header">
                                    <h3>‚ûï Quick Add Customer</h3>
                                    <button className="modal-close" onClick={() => setShowAddModal(false)}>&times;</button>
                                </div>
                                <div className="modal-body">
                                    <div style={{background:'var(--bg-dark)',padding:'1rem',borderRadius:'8px',marginBottom:'1rem'}}>
                                        <div style={{fontWeight:'600',marginBottom:'0.5rem'}}>üìç Location</div>
                                        <div style={{fontSize:'0.9rem',color:'var(--text-secondary)'}}>{searchedPlace.formatted_address}</div>
                                        <div style={{fontSize:'0.8rem',color:'var(--text-muted)',marginTop:'0.5rem'}}>
                                            {searchedPlace.address && <div>Street: {searchedPlace.address}</div>}
                                            <div>City: {searchedPlace.city}, {searchedPlace.state} {searchedPlace.zip}</div>
                                            <div>Lat: {searchedPlace.lat.toFixed(6)}, Lng: {searchedPlace.lng.toFixed(6)}</div>
                                        </div>
                                    </div>
                                    <p style={{color:'var(--text-secondary)',fontSize:'0.9rem'}}>
                                        This will create a new customer with the address above. You can edit additional details after creation.
                                    </p>
                                </div>
                                <div className="modal-footer">
                                    <button className="btn btn-secondary" onClick={() => setShowAddModal(false)}>Cancel</button>
                                    <button className="btn btn-primary" onClick={handleQuickAddCustomer} disabled={addingCustomer}>
                                        {addingCustomer ? 'Adding...' : 'Add Customer'}
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Row 1: Orders & Distribution Centers */}
                    <div className="grid-2">
                        <div className="card">
                            <div className="card-header"><h3>üì¶ Recent Orders</h3></div>
                            <div style={{maxHeight:'280px',overflow:'auto'}}>
                                <table>
                                    <thead><tr><th>Order #</th><th>Customer</th><th>Gallons</th><th>Status</th></tr></thead>
                                    <tbody>
                                        {(data?.orders || []).slice(0, 6).map(o => (
                                            <tr key={o.id}>
                                                <td><strong>{o.order_number}</strong></td>
                                                <td>{o.customer_name}</td>
                                                <td>{o.gallons_requested}</td>
                                                <td><span className={`status-badge status-${o.status}`}>{o.status}</span></td>
                                            </tr>
                                        ))}
                                        {(!data?.orders || data.orders.length === 0) && <tr><td colSpan="4" className="text-muted" style={{textAlign:'center',padding:'2rem'}}>No orders yet</td></tr>}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div className="card">
                            <div className="card-header"><h3>üè≠ Distribution Centers</h3></div>
                            <div style={{maxHeight:'280px',overflow:'auto'}}>
                                <table>
                                    <thead><tr><th>Code</th><th>Name</th><th>Location</th><th>Capacity</th><th>Status</th></tr></thead>
                                    <tbody>
                                        {(data?.distributionCenters || []).slice(0, 6).map(dc => (
                                            <tr key={dc.id}>
                                                <td><strong>{dc.code}</strong></td>
                                                <td>{dc.name}</td>
                                                <td>{dc.city}, {dc.state}</td>
                                                <td>{(dc.capacity_gallons || 0).toLocaleString()} gal</td>
                                                <td><span className={`status-badge status-${dc.status}`}>{dc.status}</span></td>
                                            </tr>
                                        ))}
                                        {(!data?.distributionCenters || data.distributionCenters.length === 0) && <tr><td colSpan="5" className="text-muted" style={{textAlign:'center',padding:'2rem'}}>No distribution centers yet</td></tr>}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    {/* Row 2: Routes & Trucks */}
                    <div className="grid-2">
                        <div className="card">
                            <div className="card-header"><h3>üó∫Ô∏è Routes</h3></div>
                            <div style={{maxHeight:'280px',overflow:'auto'}}>
                                <table>
                                    <thead><tr><th>Route #</th><th>Date</th><th>Driver</th><th>Truck</th><th>Stops</th><th>Status</th></tr></thead>
                                    <tbody>
                                        {(data?.routes || []).slice(0, 6).map(r => (
                                            <tr key={r.id}>
                                                <td><strong>{r.route_number}</strong></td>
                                                <td>{r.scheduled_date}</td>
                                                <td>{r.driver_name || '-'}</td>
                                                <td>{r.truck_name || '-'}</td>
                                                <td>{r.total_stops || 0}</td>
                                                <td><span className={`status-badge status-${r.status}`}>{r.status}</span></td>
                                            </tr>
                                        ))}
                                        {(!data?.routes || data.routes.length === 0) && <tr><td colSpan="6" className="text-muted" style={{textAlign:'center',padding:'2rem'}}>No routes yet</td></tr>}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div className="card">
                            <div className="card-header"><h3>üöö Trucks</h3></div>
                            <div style={{maxHeight:'280px',overflow:'auto'}}>
                                <table>
                                    <thead><tr><th>Code</th><th>Name</th><th>Make/Model</th><th>Capacity</th><th>DC</th><th>Status</th></tr></thead>
                                    <tbody>
                                        {(data?.trucks || []).slice(0, 6).map(t => (
                                            <tr key={t.id}>
                                                <td><strong>{t.code}</strong></td>
                                                <td>{t.name || '-'}</td>
                                                <td>{t.make} {t.model} {t.year || ''}</td>
                                                <td>{(t.capacity_gallons || 0).toLocaleString()} gal</td>
                                                <td>{t.dc_name || '-'}</td>
                                                <td><span className={`status-badge status-${t.status}`}>{t.status}</span></td>
                                            </tr>
                                        ))}
                                        {(!data?.trucks || data.trucks.length === 0) && <tr><td colSpan="6" className="text-muted" style={{textAlign:'center',padding:'2rem'}}>No trucks yet</td></tr>}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    {/* Row 3: Drivers */}
                    <div className="card">
                        <div className="card-header"><h3>üë∑ Drivers</h3></div>
                        <div style={{maxHeight:'280px',overflow:'auto'}}>
                            <table>
                                <thead><tr><th>Code</th><th>Name</th><th>Phone</th><th>CDL Class</th><th>HAZMAT</th><th>DC</th><th>Status</th></tr></thead>
                                <tbody>
                                    {(data?.drivers || []).slice(0, 6).map(d => (
                                        <tr key={d.id}>
                                            <td><strong>{d.code}</strong></td>
                                            <td>{d.name}</td>
                                            <td>{d.phone || '-'}</td>
                                            <td>{d.cdl_class || '-'}</td>
                                            <td>{d.hazmat_certified ? '‚úÖ' : '‚ùå'}</td>
                                            <td>{d.dc_name || '-'}</td>
                                            <td><span className={`status-badge status-${d.status}`}>{d.status}</span></td>
                                        </tr>
                                    ))}
                                    {(!data?.drivers || data.drivers.length === 0) && <tr><td colSpan="7" className="text-muted" style={{textAlign:'center',padding:'2rem'}}>No drivers yet</td></tr>}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </>
            );
        }

        // =====================================================
        // Stable Form Input Component (prevents focus loss)
        // =====================================================
        function FormInput({ name, label, type, value, onChange, required, placeholder, step, options }) {
            const handleChange = (e) => {
                let val = e.target.value;
                if (type === 'number' && val !== '') {
                    val = parseFloat(val);
                }
                if (type === 'checkbox') {
                    val = e.target.checked;
                }
                onChange(name, val);
            };

            if (type === 'select') {
                return (
                    <div className="form-group">
                        <label className="form-label">{label}{required && ' *'}</label>
                        <select className="form-input" value={value || ''} onChange={handleChange} required={required}>
                            <option value="">Select...</option>
                            {(options || []).map(opt => <option key={opt.value} value={opt.value}>{opt.label}</option>)}
                        </select>
                    </div>
                );
            }
            if (type === 'textarea') {
                return (
                    <div className="form-group">
                        <label className="form-label">{label}</label>
                        <textarea className="form-input" rows="3" value={value || ''} onChange={handleChange} placeholder={placeholder}></textarea>
                    </div>
                );
            }
            if (type === 'checkbox') {
                return (
                    <div className="form-group">
                        <label style={{display:'flex',alignItems:'center',gap:'0.5rem',cursor:'pointer'}}>
                            <input type="checkbox" checked={!!value} onChange={handleChange} style={{width:'18px',height:'18px'}} />
                            {label}
                        </label>
                    </div>
                );
            }

            return (
                <div className="form-group">
                    <label className="form-label">{label}{required && ' *'}</label>
                    <input 
                        type={type || 'text'} 
                        className="form-input" 
                        value={value ?? ''} 
                        onChange={handleChange} 
                        required={required}
                        step={step}
                        placeholder={placeholder}
                    />
                </div>
            );
        }

        // =====================================================
        // Reusable Entity Modal with Stable Form
        // =====================================================
        function EntityModal({ title, fields, data, onSave, onClose, loading }) {
            const [formData, setFormData] = useState(() => ({ ...data }));
            const [error, setError] = useState('');

            const handleSubmit = async (e) => {
                e.preventDefault();
                setError('');
                try {
                    await onSave(formData);
                } catch (err) {
                    setError(err.message);
                }
            };

            const handleFieldChange = (name, value) => {
                setFormData(prev => ({ ...prev, [name]: value }));
            };

            const renderField = (field, index) => {
                if (field.type === 'row') {
                    return (
                        <div key={`row-${index}`} className="form-row">
                            {field.fields.map((f, i) => (
                                <FormInput
                                    key={f.name}
                                    name={f.name}
                                    label={f.label}
                                    type={f.type}
                                    value={formData[f.name]}
                                    onChange={handleFieldChange}
                                    required={f.required}
                                    placeholder={f.placeholder}
                                    step={f.step}
                                    options={f.options}
                                />
                            ))}
                        </div>
                    );
                }
                if (field.type === 'row3') {
                    return (
                        <div key={`row3-${index}`} className="form-row-3">
                            {field.fields.map((f, i) => (
                                <FormInput
                                    key={f.name}
                                    name={f.name}
                                    label={f.label}
                                    type={f.type}
                                    value={formData[f.name]}
                                    onChange={handleFieldChange}
                                    required={f.required}
                                    placeholder={f.placeholder}
                                    step={f.step}
                                    options={f.options}
                                />
                            ))}
                        </div>
                    );
                }

                return (
                    <FormInput
                        key={field.name}
                        name={field.name}
                        label={field.label}
                        type={field.type}
                        value={formData[field.name]}
                        onChange={handleFieldChange}
                        required={field.required}
                        placeholder={field.placeholder}
                        step={field.step}
                        options={field.options}
                    />
                );
            };

            return (
                <div className="modal-overlay" onClick={(e) => e.target === e.currentTarget && onClose()}>
                    <div className="modal">
                        <div className="modal-header">
                            <h3>{title}</h3>
                            <button className="modal-close" onClick={onClose}>&times;</button>
                        </div>
                        <form onSubmit={handleSubmit}>
                            <div className="modal-body">
                                {error && <div className="error-message">{error}</div>}
                                {fields.map((field, index) => renderField(field, index))}
                            </div>
                            <div className="modal-footer">
                                <button type="button" className="btn btn-secondary" onClick={onClose}>Cancel</button>
                                <button type="submit" className="btn btn-primary" disabled={loading}>{loading ? 'Saving...' : 'Save'}</button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }

        // =====================================================
        // CUSTOMERS VIEW
        // =====================================================
        function CustomersView({ data, onRefresh }) {
            const [showModal, setShowModal] = useState(false);
            const [editItem, setEditItem] = useState(null);
            const [loading, setLoading] = useState(false);

            const dcOptions = (data?.distributionCenters || []).map(dc => ({ value: dc.id, label: dc.name }));

            const fields = [
                { type: 'row', fields: [
                    { name: 'code', label: 'Customer Code', required: true, placeholder: 'CUST-001' },
                    { name: 'name', label: 'Customer Name', required: true }
                ]},
                { type: 'row', fields: [
                    { name: 'contact_name', label: 'Contact Name' },
                    { name: 'phone', label: 'Phone' }
                ]},
                { name: 'email', label: 'Email', type: 'email' },
                { name: 'address', label: 'Address' },
                { type: 'row3', fields: [
                    { name: 'city', label: 'City' },
                    { name: 'state', label: 'State' },
                    { name: 'zip', label: 'ZIP' }
                ]},
                { type: 'row', fields: [
                    { name: 'lat', label: 'Latitude', type: 'number', step: '0.000001', placeholder: '34.730369' },
                    { name: 'lng', label: 'Longitude', type: 'number', step: '0.000001', placeholder: '-86.586104' }
                ]},
                { type: 'row', fields: [
                    { name: 'customer_type', label: 'Customer Type', type: 'select', options: [
                        { value: 'residential', label: 'Residential' },
                        { value: 'commercial', label: 'Commercial' },
                        { value: 'industrial', label: 'Industrial' }
                    ]},
                    { name: 'preferred_dc_id', label: 'Preferred DC', type: 'select', options: dcOptions }
                ]},
                { type: 'row', fields: [
                    { name: 'tank_size', label: 'Tank Size (gallons)', type: 'number' },
                    { name: 'current_level', label: 'Current Level (%)', type: 'number', step: '0.01' }
                ]},
                { type: 'row', fields: [
                    { name: 'price_per_gallon', label: 'Price per Gallon ($)', type: 'number', step: '0.01' },
                    { name: 'payment_terms', label: 'Payment Terms', type: 'select', options: [
                        { value: 'net30', label: 'Net 30' },
                        { value: 'net15', label: 'Net 15' },
                        { value: 'due_on_delivery', label: 'Due on Delivery' },
                        { value: 'prepaid', label: 'Prepaid' }
                    ]}
                ]},
                { name: 'delivery_instructions', label: 'Delivery Instructions', type: 'textarea' },
                { type: 'row', fields: [
                    { name: 'auto_delivery', label: 'Auto-Delivery Enabled', type: 'checkbox' },
                    { name: 'minimum_level', label: 'Auto-Order Below (%)', type: 'number' }
                ]},
                { name: 'status', label: 'Status', type: 'select', options: [
                    { value: 'active', label: 'Active' },
                    { value: 'inactive', label: 'Inactive' }
                ]}
            ];

            const handleSave = async (formData) => {
                setLoading(true);
                try {
                    if (editItem) {
                        await api.request(`/data/customers/${editItem.id}`, { method: 'PUT', body: JSON.stringify(formData) });
                    } else {
                        await api.request('/data/customers', { method: 'POST', body: JSON.stringify(formData) });
                    }
                    setShowModal(false);
                    setEditItem(null);
                    onRefresh();
                } finally {
                    setLoading(false);
                }
            };

            const handleDelete = async (id) => {
                if (!confirm('Delete this customer? This cannot be undone.')) return;
                await api.request(`/data/customers/${id}`, { method: 'DELETE' });
                onRefresh();
            };

            return (
                <>
                    <div className="page-header">
                        <h1 className="page-title">üë• Customers</h1>
                        <button className="btn btn-primary" onClick={() => { setEditItem(null); setShowModal(true); }}>+ Add Customer</button>
                    </div>
                    <div className="table-container">
                        <table>
                            <thead><tr><th>Code</th><th>Name</th><th>City</th><th>Type</th><th>Tank</th><th>Level</th><th>Status</th><th>Actions</th></tr></thead>
                            <tbody>
                                {(data?.customers || []).map(item => (
                                    <tr key={item.id}>
                                        <td><strong>{item.code}</strong></td>
                                        <td>{item.name}<br/><span className="text-muted" style={{fontSize:'0.85rem'}}>{item.contact_name}</span></td>
                                        <td>{item.city}, {item.state}</td>
                                        <td style={{textTransform:'capitalize'}}>{item.customer_type}</td>
                                        <td>{item.tank_size} gal</td>
                                        <td style={{color: item.current_level < 25 ? 'var(--danger)' : item.current_level < 50 ? 'var(--warning)' : 'var(--success)', fontWeight:'600'}}>{item.current_level}%</td>
                                        <td><span className={`status-badge status-${item.status}`}>{item.status}</span></td>
                                        <td>
                                            <div className="action-buttons">
                                                <button className="btn btn-sm btn-secondary" onClick={() => { setEditItem(item); setShowModal(true); }}>Edit</button>
                                                <button className="btn btn-sm btn-danger" onClick={() => handleDelete(item.id)}>Delete</button>
                                            </div>
                                        </td>
                                    </tr>
                                ))}
                                {(!data?.customers || data.customers.length === 0) && (
                                    <tr><td colSpan="8" className="empty-state">No customers yet. Click "Add Customer" to create one.</td></tr>
                                )}
                            </tbody>
                        </table>
                    </div>
                    {showModal && (
                        <CustomerFormModal
                            editItem={editItem}
                            dcOptions={dcOptions}
                            onSave={handleSave}
                            onClose={() => { setShowModal(false); setEditItem(null); }}
                            loading={loading}
                        />
                    )}
                </>
            );
        }

        // Customer Form Modal with Geocoding
        function CustomerFormModal({ editItem, dcOptions, onSave, onClose, loading }) {
            const defaultData = { status: 'active', customer_type: 'residential', tank_size: 500, current_level: 50, price_per_gallon: 2.50, payment_terms: 'net30', minimum_level: 20 };
            const [formData, setFormData] = useState(() => editItem ? { ...editItem } : { ...defaultData });
            const [error, setError] = useState('');
            const [geocoding, setGeocoding] = useState(false);
            const [geocodeMsg, setGeocodeMsg] = useState('');

            const handleFieldChange = (name, value) => {
                setFormData(prev => ({ ...prev, [name]: value }));
                setGeocodeMsg(''); // Clear geocode message on any change
            };

            const handleGeocode = async () => {
                if (!formData.address && !formData.city && !formData.state && !formData.zip) {
                    setGeocodeMsg('Please enter an address first');
                    return;
                }
                
                setGeocoding(true);
                setGeocodeMsg('');
                
                try {
                    const response = await fetch('/.netlify/functions/geocode', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            address: formData.address,
                            city: formData.city,
                            state: formData.state,
                            zip: formData.zip
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok) {
                        setFormData(prev => ({
                            ...prev,
                            lat: data.lat,
                            lng: data.lng
                        }));
                        setGeocodeMsg(`‚úì Found: ${data.formatted_address}`);
                    } else {
                        setGeocodeMsg(`‚úó ${data.error || 'Could not find address'}`);
                    }
                } catch (err) {
                    setGeocodeMsg('‚úó Geocoding service unavailable');
                } finally {
                    setGeocoding(false);
                }
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                setError('');
                try {
                    await onSave(formData);
                } catch (err) {
                    setError(err.message);
                }
            };

            return (
                <div className="modal-overlay" onClick={(e) => e.target === e.currentTarget && onClose()}>
                    <div className="modal" style={{maxWidth:'700px'}}>
                        <div className="modal-header">
                            <h3>{editItem ? 'Edit Customer' : 'Add Customer'}</h3>
                            <button className="modal-close" onClick={onClose}>&times;</button>
                        </div>
                        <form onSubmit={handleSubmit}>
                            <div className="modal-body">
                                {error && <div className="error-message">{error}</div>}
                                
                                <div className="form-row">
                                    <FormInput name="code" label="Customer Code" value={formData.code} onChange={handleFieldChange} required placeholder="CUST-001" />
                                    <FormInput name="name" label="Customer Name" value={formData.name} onChange={handleFieldChange} required />
                                </div>
                                
                                <div className="form-row">
                                    <FormInput name="contact_name" label="Contact Name" value={formData.contact_name} onChange={handleFieldChange} />
                                    <FormInput name="phone" label="Phone" value={formData.phone} onChange={handleFieldChange} />
                                </div>
                                
                                <FormInput name="email" label="Email" type="email" value={formData.email} onChange={handleFieldChange} />
                                
                                <div style={{background:'var(--bg-dark)',padding:'1rem',borderRadius:'8px',marginBottom:'1rem'}}>
                                    <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'0.75rem'}}>
                                        <strong style={{fontSize:'0.9rem'}}>üìç Address & Location</strong>
                                        <button type="button" className="btn btn-sm btn-secondary" onClick={handleGeocode} disabled={geocoding} style={{display:'flex',alignItems:'center',gap:'0.5rem'}}>
                                            {geocoding ? '‚è≥ Looking up...' : 'üåê Get Coordinates'}
                                        </button>
                                    </div>
                                    
                                    <FormInput name="address" label="Street Address" value={formData.address} onChange={handleFieldChange} placeholder="123 Main St" />
                                    
                                    <div className="form-row-3">
                                        <FormInput name="city" label="City" value={formData.city} onChange={handleFieldChange} />
                                        <FormInput name="state" label="State" value={formData.state} onChange={handleFieldChange} />
                                        <FormInput name="zip" label="ZIP" value={formData.zip} onChange={handleFieldChange} />
                                    </div>
                                    
                                    <div className="form-row">
                                        <FormInput name="lat" label="Latitude" type="number" step="0.000001" value={formData.lat} onChange={handleFieldChange} placeholder="34.730369" />
                                        <FormInput name="lng" label="Longitude" type="number" step="0.000001" value={formData.lng} onChange={handleFieldChange} placeholder="-86.586104" />
                                    </div>
                                    
                                    {geocodeMsg && (
                                        <div style={{fontSize:'0.85rem',marginTop:'0.5rem',color: geocodeMsg.startsWith('‚úì') ? 'var(--success)' : 'var(--danger)'}}>
                                            {geocodeMsg}
                                        </div>
                                    )}
                                </div>
                                
                                <div className="form-row">
                                    <FormInput name="customer_type" label="Customer Type" type="select" value={formData.customer_type} onChange={handleFieldChange} options={[
                                        { value: 'residential', label: 'Residential' },
                                        { value: 'commercial', label: 'Commercial' },
                                        { value: 'industrial', label: 'Industrial' }
                                    ]} />
                                    <FormInput name="preferred_dc_id" label="Preferred DC" type="select" value={formData.preferred_dc_id} onChange={handleFieldChange} options={dcOptions} />
                                </div>
                                
                                <div className="form-row">
                                    <FormInput name="tank_size" label="Tank Size (gallons)" type="number" value={formData.tank_size} onChange={handleFieldChange} />
                                    <FormInput name="current_level" label="Current Level (%)" type="number" step="0.01" value={formData.current_level} onChange={handleFieldChange} />
                                </div>
                                
                                <div className="form-row">
                                    <FormInput name="price_per_gallon" label="Price per Gallon ($)" type="number" step="0.01" value={formData.price_per_gallon} onChange={handleFieldChange} />
                                    <FormInput name="payment_terms" label="Payment Terms" type="select" value={formData.payment_terms} onChange={handleFieldChange} options={[
                                        { value: 'net30', label: 'Net 30' },
                                        { value: 'net15', label: 'Net 15' },
                                        { value: 'due_on_delivery', label: 'Due on Delivery' },
                                        { value: 'prepaid', label: 'Prepaid' }
                                    ]} />
                                </div>
                                
                                <FormInput name="delivery_instructions" label="Delivery Instructions" type="textarea" value={formData.delivery_instructions} onChange={handleFieldChange} />
                                
                                <div className="form-row">
                                    <FormInput name="auto_delivery" label="Auto-Delivery Enabled" type="checkbox" value={formData.auto_delivery} onChange={handleFieldChange} />
                                    <FormInput name="minimum_level" label="Auto-Order Below (%)" type="number" value={formData.minimum_level} onChange={handleFieldChange} />
                                </div>
                                
                                <FormInput name="status" label="Status" type="select" value={formData.status} onChange={handleFieldChange} options={[
                                    { value: 'active', label: 'Active' },
                                    { value: 'inactive', label: 'Inactive' }
                                ]} />
                            </div>
                            <div className="modal-footer">
                                <button type="button" className="btn btn-secondary" onClick={onClose}>Cancel</button>
                                <button type="submit" className="btn btn-primary" disabled={loading}>{loading ? 'Saving...' : 'Save'}</button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }

        // =====================================================
        // ORDERS VIEW
        // =====================================================
        function OrdersView({ data, onRefresh }) {
            const [showModal, setShowModal] = useState(false);
            const [editItem, setEditItem] = useState(null);
            const [loading, setLoading] = useState(false);

            const customerOptions = (data?.customers || []).map(c => ({ value: c.id, label: `${c.code} - ${c.name}` }));
            const dcOptions = (data?.distributionCenters || []).map(dc => ({ value: dc.id, label: dc.name }));

            const fields = [
                { name: 'customer_id', label: 'Customer', type: 'select', required: true, options: customerOptions },
                { name: 'dc_id', label: 'Distribution Center', type: 'select', options: dcOptions },
                { type: 'row', fields: [
                    { name: 'gallons_requested', label: 'Gallons Requested', type: 'number', required: true },
                    { name: 'price_per_gallon', label: 'Price per Gallon ($)', type: 'number', step: '0.01' }
                ]},
                { type: 'row', fields: [
                    { name: 'requested_date', label: 'Requested Date', type: 'date' },
                    { name: 'scheduled_date', label: 'Scheduled Date', type: 'date' }
                ]},
                { name: 'delivery_window', label: 'Delivery Window', type: 'select', options: [
                    { value: 'morning', label: 'Morning (8am-12pm)' },
                    { value: 'afternoon', label: 'Afternoon (12pm-5pm)' },
                    { value: 'anytime', label: 'Anytime' }
                ]},
                { type: 'row', fields: [
                    { name: 'priority', label: 'Priority', type: 'select', options: [
                        { value: 'low', label: 'Low' },
                        { value: 'normal', label: 'Normal' },
                        { value: 'high', label: 'High' },
                        { value: 'urgent', label: 'Urgent' }
                    ]},
                    { name: 'status', label: 'Status', type: 'select', options: [
                        { value: 'pending', label: 'Pending' },
                        { value: 'scheduled', label: 'Scheduled' },
                        { value: 'in_progress', label: 'In Progress' },
                        { value: 'delivered', label: 'Delivered' },
                        { value: 'cancelled', label: 'Cancelled' }
                    ]}
                ]},
                { name: 'delivery_notes', label: 'Delivery Notes', type: 'textarea' }
            ];

            const handleSave = async (formData) => {
                setLoading(true);
                try {
                    if (editItem) {
                        await api.request(`/data/orders/${editItem.id}`, { method: 'PUT', body: JSON.stringify(formData) });
                    } else {
                        await api.request('/data/orders', { method: 'POST', body: JSON.stringify(formData) });
                    }
                    setShowModal(false);
                    setEditItem(null);
                    onRefresh();
                } finally {
                    setLoading(false);
                }
            };

            const handleDelete = async (id) => {
                if (!confirm('Delete this order?')) return;
                await api.request(`/data/orders/${id}`, { method: 'DELETE' });
                onRefresh();
            };

            return (
                <>
                    <div className="page-header">
                        <h1 className="page-title">üì¶ Orders</h1>
                        <button className="btn btn-primary" onClick={() => { setEditItem(null); setShowModal(true); }}>+ New Order</button>
                    </div>
                    <div className="table-container">
                        <table>
                            <thead><tr><th>Order #</th><th>Customer</th><th>Gallons</th><th>Scheduled</th><th>Priority</th><th>Status</th><th>Actions</th></tr></thead>
                            <tbody>
                                {(data?.orders || []).map(item => (
                                    <tr key={item.id}>
                                        <td><strong>{item.order_number}</strong></td>
                                        <td>{item.customer_name}</td>
                                        <td>{item.gallons_requested}</td>
                                        <td>{item.scheduled_date || '-'}</td>
                                        <td style={{textTransform:'capitalize'}}>{item.priority}</td>
                                        <td><span className={`status-badge status-${item.status}`}>{item.status}</span></td>
                                        <td>
                                            <div className="action-buttons">
                                                <button className="btn btn-sm btn-secondary" onClick={() => { setEditItem(item); setShowModal(true); }}>Edit</button>
                                                <button className="btn btn-sm btn-danger" onClick={() => handleDelete(item.id)}>Delete</button>
                                            </div>
                                        </td>
                                    </tr>
                                ))}
                                {(!data?.orders || data.orders.length === 0) && (
                                    <tr><td colSpan="7" className="empty-state">No orders yet. Click "New Order" to create one.</td></tr>
                                )}
                            </tbody>
                        </table>
                    </div>
                    {showModal && (
                        <EntityModal 
                            title={editItem ? 'Edit Order' : 'New Order'}
                            fields={fields}
                            data={editItem || { status: 'pending', priority: 'normal', delivery_window: 'anytime' }}
                            onSave={handleSave}
                            onClose={() => { setShowModal(false); setEditItem(null); }}
                            loading={loading}
                        />
                    )}
                </>
            );
        }

        // =====================================================
        // ROUTE TEMPLATES VIEW - Keep-Full Service Model
        // =====================================================
        function RouteTemplatesView({ data, onRefresh }) {
            const [templates, setTemplates] = useState([]);
            const [loading, setLoading] = useState(true);
            const [showBuilder, setShowBuilder] = useState(false);
            const [editTemplate, setEditTemplate] = useState(null);
            const [error, setError] = useState('');

            // Load templates
            useEffect(() => {
                loadTemplates();
            }, []);

            const loadTemplates = async () => {
                try {
                    setLoading(true);
                    const result = await api.request('/routes-v2/templates');
                    setTemplates(result);
                } catch (err) {
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            };

            const handleDelete = async (id) => {
                if (!confirm('Delete this route template?')) return;
                try {
                    await api.request(`/routes-v2/templates/${id}`, { method: 'DELETE' });
                    loadTemplates();
                } catch (err) {
                    alert('Error: ' + err.message);
                }
            };

            const handleStartRoute = async (template) => {
                try {
                    const result = await api.request('/routes-v2/runs', {
                        method: 'POST',
                        body: JSON.stringify({
                            template_id: template.id,
                            scheduled_date: new Date().toISOString().split('T')[0]
                        })
                    });
                    alert('Route started! Route ID: ' + result.id);
                    onRefresh();
                } catch (err) {
                    alert('Error: ' + err.message);
                }
            };

            const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];

            if (showBuilder) {
                return <RouteTemplateBuilder 
                    data={data} 
                    template={editTemplate}
                    onBack={() => { setShowBuilder(false); setEditTemplate(null); }}
                    onSave={() => { setShowBuilder(false); setEditTemplate(null); loadTemplates(); }}
                />;
            }

            return (
                <>
                    <div className="page-header">
                        <div>
                            <h1>üó∫Ô∏è Route Templates</h1>
                            <p className="text-muted">Recurring routes for keep-full service</p>
                        </div>
                        <button className="btn btn-primary" onClick={() => setShowBuilder(true)}>
                            + Create Template
                        </button>
                    </div>

                    {error && <div className="error-message">{error}</div>}

                    {loading ? (
                        <div className="loading"><div className="spinner"></div></div>
                    ) : templates.length === 0 ? (
                        <div className="card" style={{textAlign:'center',padding:'3rem'}}>
                            <div style={{fontSize:'3rem',marginBottom:'1rem'}}>üó∫Ô∏è</div>
                            <h3>No Route Templates Yet</h3>
                            <p className="text-muted" style={{marginBottom:'1.5rem'}}>Create recurring routes by selecting customers and optimizing stop order</p>
                            <button className="btn btn-primary" onClick={() => setShowBuilder(true)}>+ Create First Template</button>
                        </div>
                    ) : (
                        <div className="card">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Route Name</th>
                                        <th>Day</th>
                                        <th>DC</th>
                                        <th>Driver</th>
                                        <th>Stops</th>
                                        <th>Est. Miles</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {templates.map(t => (
                                        <tr key={t.id}>
                                            <td><strong>{t.name}</strong></td>
                                            <td>{t.day_of_week !== null ? dayNames[t.day_of_week] : '‚Äî'}</td>
                                            <td>{t.dc_name || '‚Äî'}</td>
                                            <td>{t.driver_name || 'Unassigned'}</td>
                                            <td>{t.stop_count || t.total_stops || 0}</td>
                                            <td>{t.estimated_miles ? `${t.estimated_miles} mi` : '‚Äî'}</td>
                                            <td><span className={`status-badge status-${t.status}`}>{t.status}</span></td>
                                            <td>
                                                <div style={{display:'flex',gap:'0.5rem'}}>
                                                    <button className="btn btn-success btn-sm" onClick={() => handleStartRoute(t)} title="Start this route today">‚ñ∂Ô∏è Run</button>
                                                    <button className="btn btn-secondary btn-sm" onClick={() => { setEditTemplate(t); setShowBuilder(true); }}>‚úèÔ∏è</button>
                                                    <button className="btn btn-danger btn-sm" onClick={() => handleDelete(t.id)}>üóëÔ∏è</button>
                                                </div>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    )}
                </>
            );
        }

        // =====================================================
        // ROUTE TEMPLATE BUILDER
        // =====================================================
        function RouteTemplateBuilder({ data, template, onBack, onSave }) {
            const [templateName, setTemplateName] = useState(template?.name || '');
            const [selectedDC, setSelectedDC] = useState(template?.dc_id || '');
            const [dayOfWeek, setDayOfWeek] = useState(template?.day_of_week ?? '');
            const [assignedDriver, setAssignedDriver] = useState(template?.assigned_driver_id || '');
            const [assignedTruck, setAssignedTruck] = useState(template?.assigned_truck_id || '');
            const [selectedCustomers, setSelectedCustomers] = useState([]);
            const [optimizedStops, setOptimizedStops] = useState([]);
            const [loading, setLoading] = useState(false);
            const [optimizing, setOptimizing] = useState(false);
            const [error, setError] = useState('');
            const [summary, setSummary] = useState(null);
            const mapRef = useRef(null);
            const mapInstance = useRef(null);
            const markersRef = useRef([]);

            // Get customers for selected DC
            const dcCustomers = (data?.customers || []).filter(c => 
                c.status === 'active' && 
                (!selectedDC || c.preferred_dc_id === selectedDC || !c.preferred_dc_id) &&
                c.lat && c.lng
            );

            // Load existing stops if editing
            useEffect(() => {
                if (template?.id) {
                    loadTemplateStops();
                }
            }, [template]);

            const loadTemplateStops = async () => {
                try {
                    const result = await api.request(`/routes-v2/templates/${template.id}`);
                    if (result.stops) {
                        setSelectedCustomers(result.stops.map(s => s.customer_id));
                        setOptimizedStops(result.stops);
                    }
                } catch (err) {
                    console.error('Error loading template stops:', err);
                }
            };

            // Initialize map
            useEffect(() => {
                if (!mapRef.current || mapInstance.current) return;

                const hq = (data?.distributionCenters || [])[0];
                const map = new google.maps.Map(mapRef.current, {
                    center: { lat: hq?.lat ? parseFloat(hq.lat) : 39.8, lng: hq?.lng ? parseFloat(hq.lng) : -98.5 },
                    zoom: hq?.lat ? 9 : 4,
                    mapTypeControl: true,
                    streetViewControl: false
                });
                mapInstance.current = map;
            }, []);

            // Update map markers when customers selected or optimized
            useEffect(() => {
                if (!mapInstance.current) return;
                const map = mapInstance.current;

                // Clear existing
                markersRef.current.forEach(m => m.setMap(null));
                markersRef.current = [];

                const bounds = new google.maps.LatLngBounds();
                const dc = (data?.distributionCenters || []).find(d => d.id === selectedDC);

                // DC marker
                if (dc?.lat && dc?.lng) {
                    const dcMarker = new google.maps.Marker({
                        position: { lat: parseFloat(dc.lat), lng: parseFloat(dc.lng) },
                        map,
                        title: dc.name,
                        icon: {
                            url: 'data:image/svg+xml,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="#6366F1"><path d="M12 2L2 7v10l10 5 10-5V7L12 2z"/></svg>'),
                            scaledSize: new google.maps.Size(32, 32)
                        }
                    });
                    markersRef.current.push(dcMarker);
                    bounds.extend(dcMarker.getPosition());
                }

                // Customer markers (numbered if optimized)
                const stopsToShow = optimizedStops.length > 0 ? optimizedStops : 
                    dcCustomers.filter(c => selectedCustomers.includes(c.id)).map((c, i) => ({ ...c, customer_id: c.id, stop_number: i + 1 }));

                stopsToShow.forEach((stop, idx) => {
                    const cust = optimizedStops.length > 0 ? 
                        dcCustomers.find(c => c.id === stop.customer_id) || stop : 
                        stop;
                    
                    if (!cust.lat || !cust.lng) return;

                    const isOptimized = optimizedStops.length > 0;
                    const marker = new google.maps.Marker({
                        position: { lat: parseFloat(cust.lat), lng: parseFloat(cust.lng) },
                        map,
                        title: cust.name || cust.customer_name,
                        label: isOptimized ? {
                            text: String(stop.stop_number),
                            color: 'white',
                            fontWeight: 'bold'
                        } : null,
                        icon: isOptimized ? {
                            path: google.maps.SymbolPath.CIRCLE,
                            scale: 14,
                            fillColor: '#10B981',
                            fillOpacity: 1,
                            strokeColor: 'white',
                            strokeWeight: 2
                        } : {
                            path: google.maps.SymbolPath.CIRCLE,
                            scale: 8,
                            fillColor: '#F59E0B',
                            fillOpacity: 1,
                            strokeColor: 'white',
                            strokeWeight: 2
                        }
                    });

                    const infoWindow = new google.maps.InfoWindow({
                        content: `<div style="color:#333"><strong>${isOptimized ? `Stop #${stop.stop_number}: ` : ''}${cust.name || cust.customer_name}</strong><br/>${cust.address || ''}<br/>Tank: ${cust.tank_size || '?'} gal @ ${cust.current_level || '?'}%</div>`
                    });
                    marker.addListener('click', () => infoWindow.open(map, marker));
                    markersRef.current.push(marker);
                    bounds.extend(marker.getPosition());
                });

                // Draw route line if optimized
                if (optimizedStops.length > 1 && dc?.lat) {
                    const path = [
                        { lat: parseFloat(dc.lat), lng: parseFloat(dc.lng) },
                        ...optimizedStops.map(s => {
                            const c = dcCustomers.find(c => c.id === s.customer_id) || s;
                            return { lat: parseFloat(c.lat || s.lat), lng: parseFloat(c.lng || s.lng) };
                        }),
                        { lat: parseFloat(dc.lat), lng: parseFloat(dc.lng) }
                    ];

                    const routeLine = new google.maps.Polyline({
                        path,
                        geodesic: true,
                        strokeColor: '#6366F1',
                        strokeOpacity: 0.8,
                        strokeWeight: 3,
                        map
                    });
                    markersRef.current.push(routeLine);
                }

                if (markersRef.current.length > 1) {
                    map.fitBounds(bounds);
                }
            }, [selectedCustomers, optimizedStops, selectedDC]);

            const handleToggleCustomer = (customerId) => {
                setOptimizedStops([]); // Clear optimization when selection changes
                setSummary(null);
                setSelectedCustomers(prev => 
                    prev.includes(customerId) 
                        ? prev.filter(id => id !== customerId)
                        : [...prev, customerId]
                );
            };

            const handleSelectAll = () => {
                setOptimizedStops([]);
                setSummary(null);
                setSelectedCustomers(dcCustomers.map(c => c.id));
            };

            const handleClearAll = () => {
                setOptimizedStops([]);
                setSummary(null);
                setSelectedCustomers([]);
            };

            const handleOptimize = async () => {
                if (!selectedDC) {
                    setError('Please select a distribution center');
                    return;
                }
                if (selectedCustomers.length < 2) {
                    setError('Please select at least 2 customers');
                    return;
                }

                setOptimizing(true);
                setError('');

                try {
                    const result = await api.request('/routes-v2/optimize', {
                        method: 'POST',
                        body: JSON.stringify({
                            dc_id: selectedDC,
                            customer_ids: selectedCustomers
                        })
                    });

                    setOptimizedStops(result.stops);
                    setSummary(result.summary);
                } catch (err) {
                    setError(err.message);
                } finally {
                    setOptimizing(false);
                }
            };

            const handleSave = async () => {
                if (!templateName.trim()) {
                    setError('Please enter a route name');
                    return;
                }
                if (!selectedDC) {
                    setError('Please select a distribution center');
                    return;
                }
                if (optimizedStops.length === 0 && selectedCustomers.length === 0) {
                    setError('Please add customers to the route');
                    return;
                }

                setLoading(true);
                setError('');

                try {
                    // Create or update template
                    let templateId = template?.id;
                    
                    // Include estimated miles/duration from optimization if available
                    const templateData = {
                        name: templateName,
                        dc_id: selectedDC,
                        day_of_week: dayOfWeek !== '' ? parseInt(dayOfWeek) : null,
                        assigned_driver_id: assignedDriver || null,
                        assigned_truck_id: assignedTruck || null,
                        status: 'active'
                    };
                    
                    if (summary) {
                        templateData.estimated_miles = summary.total_miles;
                        templateData.estimated_duration_minutes = summary.estimated_total_time_minutes;
                    }
                    
                    if (templateId) {
                        await api.request(`/routes-v2/templates/${templateId}`, {
                            method: 'PUT',
                            body: JSON.stringify(templateData)
                        });
                    } else {
                        const result = await api.request('/routes-v2/templates', {
                            method: 'POST',
                            body: JSON.stringify(templateData)
                        });
                        templateId = result.id;
                    }

                    // Save stops
                    const stopsToSave = optimizedStops.length > 0 ? optimizedStops : 
                        selectedCustomers.map((id, idx) => ({ customer_id: id, stop_number: idx + 1 }));

                    await api.request(`/routes-v2/templates/${templateId}/stops`, {
                        method: 'POST',
                        body: JSON.stringify({ stops: stopsToSave })
                    });

                    onSave();
                } catch (err) {
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            };

            const dayOptions = [
                { value: '', label: 'No specific day' },
                { value: '0', label: 'Sunday' },
                { value: '1', label: 'Monday' },
                { value: '2', label: 'Tuesday' },
                { value: '3', label: 'Wednesday' },
                { value: '4', label: 'Thursday' },
                { value: '5', label: 'Friday' },
                { value: '6', label: 'Saturday' }
            ];

            return (
                <>
                    <div className="page-header">
                        <div style={{display:'flex',alignItems:'center',gap:'1rem'}}>
                            <button className="btn btn-secondary" onClick={onBack}>‚Üê Back</button>
                            <div>
                                <h1>{template ? 'Edit' : 'Create'} Route Template</h1>
                                <p className="text-muted">Select customers and optimize the route</p>
                            </div>
                        </div>
                    </div>

                    {error && <div className="error-message" style={{marginBottom:'1rem'}}>{error}</div>}

                    <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:'1.5rem'}}>
                        {/* Left Panel - Configuration */}
                        <div>
                            {/* Template Settings */}
                            <div className="card" style={{marginBottom:'1rem'}}>
                                <div className="card-header"><h3>üìã Route Settings</h3></div>
                                <div className="card-body">
                                    <div className="form-group">
                                        <label>Route Name *</label>
                                        <input type="text" className="form-control" value={templateName} onChange={e => setTemplateName(e.target.value)} placeholder="e.g., Monday North Route" />
                                    </div>
                                    <div className="form-row">
                                        <div className="form-group">
                                            <label>Distribution Center *</label>
                                            <select className="form-control" value={selectedDC} onChange={e => { setSelectedDC(e.target.value); setSelectedCustomers([]); setOptimizedStops([]); }}>
                                                <option value="">Select DC...</option>
                                                {(data?.distributionCenters || []).map(dc => (
                                                    <option key={dc.id} value={dc.id}>{dc.name}</option>
                                                ))}
                                            </select>
                                        </div>
                                        <div className="form-group">
                                            <label>Day of Week</label>
                                            <select className="form-control" value={dayOfWeek} onChange={e => setDayOfWeek(e.target.value)}>
                                                {dayOptions.map(d => <option key={d.value} value={d.value}>{d.label}</option>)}
                                            </select>
                                        </div>
                                    </div>
                                    <div className="form-row">
                                        <div className="form-group">
                                            <label>Assigned Driver</label>
                                            <select className="form-control" value={assignedDriver} onChange={e => setAssignedDriver(e.target.value)}>
                                                <option value="">Unassigned</option>
                                                {(data?.drivers || []).filter(d => d.status === 'active').map(d => (
                                                    <option key={d.id} value={d.id}>{d.name}</option>
                                                ))}
                                            </select>
                                        </div>
                                        <div className="form-group">
                                            <label>Assigned Truck</label>
                                            <select className="form-control" value={assignedTruck} onChange={e => setAssignedTruck(e.target.value)}>
                                                <option value="">Unassigned</option>
                                                {(data?.trucks || []).filter(t => t.status === 'active').map(t => (
                                                    <option key={t.id} value={t.id}>{t.code} - {t.name}</option>
                                                ))}
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            {/* Customer Selection */}
                            <div className="card">
                                <div className="card-header" style={{display:'flex',justifyContent:'space-between',alignItems:'center'}}>
                                    <h3>üë• Select Customers ({selectedCustomers.length} selected)</h3>
                                    <div style={{display:'flex',gap:'0.5rem'}}>
                                        <button className="btn btn-sm btn-secondary" onClick={handleSelectAll}>Select All</button>
                                        <button className="btn btn-sm btn-secondary" onClick={handleClearAll}>Clear</button>
                                    </div>
                                </div>
                                <div style={{maxHeight:'350px',overflow:'auto'}}>
                                    {!selectedDC ? (
                                        <div className="text-muted" style={{textAlign:'center',padding:'2rem'}}>
                                            ‚¨ÜÔ∏è Select a Distribution Center first
                                        </div>
                                    ) : dcCustomers.length === 0 ? (
                                        <div className="text-muted" style={{textAlign:'center',padding:'2rem'}}>
                                            No customers with coordinates found for this DC
                                        </div>
                                    ) : (
                                        <table>
                                            <thead><tr><th style={{width:'40px'}}></th><th>Customer</th><th>City</th><th>Tank</th><th>Level</th></tr></thead>
                                            <tbody>
                                                {dcCustomers.map(cust => (
                                                    <tr key={cust.id} style={{cursor:'pointer'}} onClick={() => handleToggleCustomer(cust.id)}>
                                                        <td>
                                                            <input type="checkbox" checked={selectedCustomers.includes(cust.id)} onChange={() => {}} style={{width:'18px',height:'18px'}} />
                                                        </td>
                                                        <td><strong>{cust.name}</strong><br/><small className="text-muted">{cust.code}</small></td>
                                                        <td>{cust.city}</td>
                                                        <td>{cust.tank_size} gal</td>
                                                        <td>
                                                            <span style={{color: cust.current_level <= 25 ? 'var(--danger)' : cust.current_level <= 50 ? 'var(--warning)' : 'var(--success)'}}>
                                                                {cust.current_level}%
                                                            </span>
                                                        </td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    )}
                                </div>
                            </div>

                            {/* Optimize Button */}
                            <button 
                                className="btn btn-success btn-block" 
                                onClick={handleOptimize}
                                disabled={optimizing || selectedCustomers.length < 2 || !selectedDC}
                                style={{marginTop:'1rem',padding:'1rem',fontSize:'1.1rem'}}
                            >
                                {optimizing ? '‚è≥ Optimizing...' : 'üöÄ Optimize Stop Order'}
                            </button>
                        </div>

                        {/* Right Panel - Map & Results */}
                        <div>
                            <div className="card">
                                <div className="card-header"><h3>üó∫Ô∏è Route Map</h3></div>
                                <div style={{height:'400px'}}>
                                    <div ref={mapRef} style={{height:'100%',width:'100%',borderRadius:'0 0 12px 12px'}}></div>
                                </div>
                            </div>

                            {/* Optimization Results */}
                            {summary && (
                                <div className="card" style={{marginTop:'1rem',borderColor:'var(--success)'}}>
                                    <div className="card-header" style={{background:'rgba(16,185,129,0.1)'}}>
                                        <h3 style={{color:'var(--success)'}}>‚úÖ Route Optimized!</h3>
                                    </div>
                                    <div className="card-body">
                                        <div style={{display:'grid',gridTemplateColumns:'repeat(3,1fr)',gap:'1rem',textAlign:'center'}}>
                                            <div>
                                                <div style={{fontSize:'1.5rem',fontWeight:'700',color:'var(--primary)'}}>{summary.total_stops}</div>
                                                <div className="text-muted">Stops</div>
                                            </div>
                                            <div>
                                                <div style={{fontSize:'1.5rem',fontWeight:'700',color:'var(--primary)'}}>{summary.total_miles} mi</div>
                                                <div className="text-muted">Total Distance</div>
                                            </div>
                                            <div>
                                                <div style={{fontSize:'1.5rem',fontWeight:'700',color:'var(--primary)'}}>{Math.floor(summary.estimated_total_time_minutes / 60)}h {summary.estimated_total_time_minutes % 60}m</div>
                                                <div className="text-muted">Est. Duration</div>
                                            </div>
                                        </div>

                                        {/* Stop Order */}
                                        <div style={{marginTop:'1rem',maxHeight:'200px',overflow:'auto'}}>
                                            <table style={{fontSize:'0.9rem'}}>
                                                <thead><tr><th>#</th><th>Customer</th><th>City</th><th>Distance</th></tr></thead>
                                                <tbody>
                                                    {optimizedStops.map((stop, idx) => (
                                                        <tr key={stop.customer_id}>
                                                            <td><strong>{stop.stop_number}</strong></td>
                                                            <td>{stop.customer_name}</td>
                                                            <td>{stop.city}</td>
                                                            <td>{stop.distance_from_previous} mi</td>
                                                        </tr>
                                                    ))}
                                                </tbody>
                                            </table>
                                        </div>

                                        <button 
                                            className="btn btn-primary btn-block" 
                                            onClick={handleSave}
                                            disabled={loading}
                                            style={{marginTop:'1rem',padding:'1rem'}}
                                        >
                                            {loading ? 'Saving...' : 'üíæ Save Route Template'}
                                        </button>
                                    </div>
                                </div>
                            )}

                            {/* Save without optimization */}
                            {!summary && selectedCustomers.length > 0 && (
                                <button 
                                    className="btn btn-secondary btn-block" 
                                    onClick={handleSave}
                                    disabled={loading || !templateName}
                                    style={{marginTop:'1rem',padding:'1rem'}}
                                >
                                    {loading ? 'Saving...' : 'üíæ Save Without Optimization'}
                                </button>
                            )}
                        </div>
                    </div>
                </>
            );
        }

        // =====================================================
        // ACTIVE ROUTES VIEW - Route Runs in Progress
        // =====================================================
        function ActiveRoutesView({ data, onRefresh }) {
            const [runs, setRuns] = useState([]);
            const [loading, setLoading] = useState(true);
            const [selectedRun, setSelectedRun] = useState(null);
            const [error, setError] = useState('');

            useEffect(() => {
                loadRuns();
            }, []);

            const loadRuns = async () => {
                try {
                    setLoading(true);
                    const result = await api.request('/routes-v2/runs');
                    setRuns(result);
                } catch (err) {
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            };

            const handleStatusChange = async (runId, newStatus) => {
                try {
                    await api.request(`/routes-v2/runs/${runId}`, {
                        method: 'PUT',
                        body: JSON.stringify({ status: newStatus })
                    });
                    loadRuns();
                } catch (err) {
                    alert('Error: ' + err.message);
                }
            };

            const getStatusColor = (status) => {
                switch(status) {
                    case 'scheduled': return 'var(--text-muted)';
                    case 'in_progress': return 'var(--warning)';
                    case 'completed': return 'var(--success)';
                    case 'cancelled': return 'var(--danger)';
                    default: return 'var(--text-secondary)';
                }
            };

            if (selectedRun) {
                return <RouteRunDetail run={selectedRun} onBack={() => { setSelectedRun(null); loadRuns(); }} />;
            }

            return (
                <>
                    <div className="page-header">
                        <div>
                            <h1>üöÄ Active Routes</h1>
                            <p className="text-muted">Today's routes and route history</p>
                        </div>
                        <button className="btn btn-secondary" onClick={loadRuns}>‚Üª Refresh</button>
                    </div>

                    {error && <div className="error-message">{error}</div>}

                    {loading ? (
                        <div className="loading"><div className="spinner"></div></div>
                    ) : runs.length === 0 ? (
                        <div className="card" style={{textAlign:'center',padding:'3rem'}}>
                            <div style={{fontSize:'3rem',marginBottom:'1rem'}}>üöÄ</div>
                            <h3>No Active Routes</h3>
                            <p className="text-muted">Start a route from Route Templates to begin deliveries</p>
                        </div>
                    ) : (
                        <div className="card">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Route</th>
                                        <th>Date</th>
                                        <th>Driver</th>
                                        <th>Truck</th>
                                        <th>Progress</th>
                                        <th>Gallons</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {runs.map(run => (
                                        <tr key={run.id}>
                                            <td><strong>{run.name || run.template_name || 'Ad-hoc Route'}</strong></td>
                                            <td>{new Date(run.scheduled_date).toLocaleDateString()}</td>
                                            <td>{run.driver_name || 'Unassigned'}</td>
                                            <td>{run.truck_code || '‚Äî'}</td>
                                            <td>
                                                <div style={{display:'flex',alignItems:'center',gap:'0.5rem'}}>
                                                    <div style={{flex:1,height:'8px',background:'var(--bg-dark)',borderRadius:'4px',overflow:'hidden'}}>
                                                        <div style={{width:`${(run.stops_completed / run.total_stops) * 100}%`,height:'100%',background:'var(--success)'}}></div>
                                                    </div>
                                                    <span style={{fontSize:'0.85rem'}}>{run.stops_completed}/{run.total_stops}</span>
                                                </div>
                                            </td>
                                            <td>{run.total_gallons_delivered ? `${parseFloat(run.total_gallons_delivered).toLocaleString()} gal` : '‚Äî'}</td>
                                            <td><span style={{color: getStatusColor(run.status),fontWeight:'600'}}>{run.status}</span></td>
                                            <td>
                                                <div style={{display:'flex',gap:'0.5rem'}}>
                                                    <button className="btn btn-primary btn-sm" onClick={() => setSelectedRun(run)}>View</button>
                                                    {run.status === 'scheduled' && (
                                                        <button className="btn btn-success btn-sm" onClick={() => handleStatusChange(run.id, 'in_progress')}>Start</button>
                                                    )}
                                                    {run.status === 'in_progress' && (
                                                        <button className="btn btn-warning btn-sm" onClick={() => handleStatusChange(run.id, 'completed')}>Complete</button>
                                                    )}
                                                </div>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    )}
                </>
            );
        }

        // =====================================================
        // ROUTE RUN DETAIL - View/Edit stops during a run
        // =====================================================
        function RouteRunDetail({ run, onBack }) {
            const [runData, setRunData] = useState(null);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                loadRunDetail();
            }, [run.id]);

            const loadRunDetail = async () => {
                try {
                    const result = await api.request(`/routes-v2/runs/${run.id}`);
                    setRunData(result);
                } catch (err) {
                    console.error(err);
                } finally {
                    setLoading(false);
                }
            };

            const handleStopUpdate = async (stopId, updates) => {
                try {
                    await api.request(`/routes-v2/runs/${run.id}/stops/${stopId}`, {
                        method: 'PUT',
                        body: JSON.stringify(updates)
                    });
                    loadRunDetail();
                } catch (err) {
                    alert('Error: ' + err.message);
                }
            };

            const handleCompleteStop = async (stop) => {
                const gallons = prompt('Gallons delivered (0 if tank was full):', '0');
                if (gallons === null) return;
                
                const tankAfter = prompt('Tank level after fill (%):', '100');
                if (tankAfter === null) return;

                await handleStopUpdate(stop.id, {
                    status: 'completed',
                    gallons_delivered: parseFloat(gallons) || 0,
                    tank_level_after: parseFloat(tankAfter) || 100,
                    delivery_total: (parseFloat(gallons) || 0) * (stop.price_per_gallon || 2.50),
                    arrived_at: new Date().toISOString(),
                    departed_at: new Date().toISOString()
                });
            };

            const handleSkipStop = async (stop) => {
                const reason = prompt('Reason for skipping:');
                if (!reason) return;
                
                await handleStopUpdate(stop.id, {
                    status: 'skipped',
                    skip_reason: reason
                });
            };

            if (loading) return <div className="loading"><div className="spinner"></div></div>;

            return (
                <>
                    <div className="page-header">
                        <div style={{display:'flex',alignItems:'center',gap:'1rem'}}>
                            <button className="btn btn-secondary" onClick={onBack}>‚Üê Back</button>
                            <div>
                                <h1>{runData?.name || 'Route'}</h1>
                                <p className="text-muted">{new Date(runData?.scheduled_date).toLocaleDateString()} ‚Ä¢ {runData?.driver_name || 'No driver'} ‚Ä¢ {runData?.truck_code || 'No truck'}</p>
                            </div>
                        </div>
                        <div className="stats-grid" style={{gap:'1rem'}}>
                            <div className="stat-card" style={{padding:'0.75rem 1rem'}}>
                                <div className="stat-value">{runData?.stops_completed}/{runData?.total_stops}</div>
                                <div className="stat-label">Stops</div>
                            </div>
                            <div className="stat-card" style={{padding:'0.75rem 1rem'}}>
                                <div className="stat-value">{parseFloat(runData?.total_gallons_delivered || 0).toLocaleString()}</div>
                                <div className="stat-label">Gallons</div>
                            </div>
                            <div className="stat-card" style={{padding:'0.75rem 1rem'}}>
                                <div className="stat-value">${parseFloat(runData?.total_revenue || 0).toLocaleString()}</div>
                                <div className="stat-label">Revenue</div>
                            </div>
                        </div>
                    </div>

                    <div className="card">
                        <table>
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Customer</th>
                                    <th>Address</th>
                                    <th>Tank Before</th>
                                    <th>Gallons</th>
                                    <th>Tank After</th>
                                    <th>Total</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {(runData?.stops || []).map(stop => (
                                    <tr key={stop.id} style={{opacity: stop.status === 'skipped' ? 0.5 : 1}}>
                                        <td><strong>{stop.stop_number}</strong></td>
                                        <td>
                                            <strong>{stop.customer_name}</strong>
                                            {stop.phone && <><br/><small className="text-muted">{stop.phone}</small></>}
                                        </td>
                                        <td>{stop.address}<br/><small className="text-muted">{stop.city}, {stop.state}</small></td>
                                        <td>
                                            <span style={{color: stop.tank_level_before <= 25 ? 'var(--danger)' : stop.tank_level_before <= 50 ? 'var(--warning)' : 'var(--success)'}}>
                                                {stop.tank_level_before}%
                                            </span>
                                            <br/><small className="text-muted">{stop.tank_size_gallons} gal tank</small>
                                        </td>
                                        <td><strong>{stop.gallons_delivered || '‚Äî'}</strong></td>
                                        <td>{stop.tank_level_after ? `${stop.tank_level_after}%` : '‚Äî'}</td>
                                        <td>{stop.delivery_total ? `$${parseFloat(stop.delivery_total).toFixed(2)}` : '‚Äî'}</td>
                                        <td>
                                            <span className={`status-badge status-${stop.status}`}>{stop.status}</span>
                                            {stop.skip_reason && <><br/><small className="text-muted">{stop.skip_reason}</small></>}
                                        </td>
                                        <td>
                                            {stop.status === 'pending' && (
                                                <div style={{display:'flex',gap:'0.5rem'}}>
                                                    <button className="btn btn-success btn-sm" onClick={() => handleCompleteStop(stop)}>‚úì Complete</button>
                                                    <button className="btn btn-warning btn-sm" onClick={() => handleSkipStop(stop)}>Skip</button>
                                                </div>
                                            )}
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </>
            );
        }

        // =====================================================
        // ROUTES VIEW - With Route Optimization (Legacy)
        // =====================================================
        function RoutesView({ data, onRefresh }) {
            const [showModal, setShowModal] = useState(false);
            const [editItem, setEditItem] = useState(null);
            const [loading, setLoading] = useState(false);
            const [selectedRoute, setSelectedRoute] = useState(null);
            const [showBuilder, setShowBuilder] = useState(false);

            const dcOptions = (data?.distributionCenters || []).map(dc => ({ value: dc.id, label: dc.name }));
            const driverOptions = (data?.drivers || []).map(d => ({ value: d.id, label: `${d.code} - ${d.name}` }));
            const truckOptions = (data?.trucks || []).map(t => ({ value: t.id, label: `${t.code} - ${t.name || t.make + ' ' + t.model}` }));

            const fields = [
                { name: 'name', label: 'Route Name', placeholder: 'Morning Deliveries' },
                { name: 'dc_id', label: 'Distribution Center', type: 'select', required: true, options: dcOptions },
                { type: 'row', fields: [
                    { name: 'scheduled_date', label: 'Scheduled Date', type: 'date', required: true },
                    { name: 'start_time', label: 'Start Time', type: 'time' }
                ]},
                { type: 'row', fields: [
                    { name: 'driver_id', label: 'Driver', type: 'select', options: driverOptions },
                    { name: 'truck_id', label: 'Truck', type: 'select', options: truckOptions }
                ]},
                { name: 'status', label: 'Status', type: 'select', options: [
                    { value: 'planned', label: 'Planned' },
                    { value: 'in_progress', label: 'In Progress' },
                    { value: 'completed', label: 'Completed' },
                    { value: 'cancelled', label: 'Cancelled' }
                ]}
            ];

            const handleSave = async (formData) => {
                setLoading(true);
                try {
                    if (editItem) {
                        await api.request(`/data/routes/${editItem.id}`, { method: 'PUT', body: JSON.stringify(formData) });
                    } else {
                        await api.request('/data/routes', { method: 'POST', body: JSON.stringify(formData) });
                    }
                    setShowModal(false);
                    setEditItem(null);
                    onRefresh();
                } finally {
                    setLoading(false);
                }
            };

            const handleDelete = async (id) => {
                if (!confirm('Delete this route?')) return;
                await api.request(`/data/routes/${id}`, { method: 'DELETE' });
                onRefresh();
            };

            if (showBuilder) {
                return <RouteBuilder data={data} onBack={() => { setShowBuilder(false); onRefresh(); }} onRefresh={onRefresh} />;
            }

            return (
                <>
                    <div className="page-header">
                        <h1 className="page-title">üó∫Ô∏è Routes</h1>
                        <div style={{display:'flex',gap:'0.75rem'}}>
                            <button className="btn btn-success" onClick={() => setShowBuilder(true)}>üöÄ Build & Optimize Route</button>
                            <button className="btn btn-primary" onClick={() => { setEditItem(null); setShowModal(true); }}>+ New Route</button>
                        </div>
                    </div>
                    <div className="table-container">
                        <table>
                            <thead><tr><th>Route #</th><th>Name</th><th>Date</th><th>Driver</th><th>Truck</th><th>Stops</th><th>Miles</th><th>Status</th><th>Actions</th></tr></thead>
                            <tbody>
                                {(data?.routes || []).map(item => (
                                    <tr key={item.id}>
                                        <td><strong>{item.route_number}</strong></td>
                                        <td>{item.name || '-'}</td>
                                        <td>{item.scheduled_date}</td>
                                        <td>{item.driver_name || '-'}</td>
                                        <td>{item.truck_name || '-'}</td>
                                        <td>{item.total_stops || 0}</td>
                                        <td>{item.total_miles ? `${item.total_miles} mi` : '-'}</td>
                                        <td>
                                            <span className={`status-badge status-${item.status}`}>{item.status}</span>
                                            {item.is_optimized && <span style={{marginLeft:'0.5rem',color:'var(--success)'}}>‚úì</span>}
                                        </td>
                                        <td>
                                            <div className="action-buttons">
                                                <button className="btn btn-sm btn-secondary" onClick={() => { setEditItem(item); setShowModal(true); }}>Edit</button>
                                                <button className="btn btn-sm btn-danger" onClick={() => handleDelete(item.id)}>Delete</button>
                                            </div>
                                        </td>
                                    </tr>
                                ))}
                                {(!data?.routes || data.routes.length === 0) && (
                                    <tr><td colSpan="9" className="empty-state">No routes yet. Click "Build & Optimize Route" to create one.</td></tr>
                                )}
                            </tbody>
                        </table>
                    </div>
                    {showModal && (
                        <EntityModal 
                            title={editItem ? 'Edit Route' : 'New Route'}
                            fields={fields}
                            data={editItem || { status: 'planned', start_time: '08:00' }}
                            onSave={handleSave}
                            onClose={() => { setShowModal(false); setEditItem(null); }}
                            loading={loading}
                        />
                    )}
                </>
            );
        }

        // =====================================================
        // ROUTE BUILDER - Optimization Interface
        // =====================================================
        function RouteBuilder({ data, onBack, onRefresh }) {
            const [selectedDC, setSelectedDC] = useState('');
            const [selectedTruck, setSelectedTruck] = useState('');
            const [selectedOrders, setSelectedOrders] = useState([]);
            const [optimizedRoute, setOptimizedRoute] = useState(null);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');
            const [fuelPrice, setFuelPrice] = useState(3.50);
            const [routeName, setRouteName] = useState('');
            const [scheduledDate, setScheduledDate] = useState(new Date().toISOString().split('T')[0]);
            const mapRef = useRef(null);
            const mapInstance = useRef(null);
            const markersRef = useRef([]);
            const polylineRef = useRef(null);
            const directionsRendererRef = useRef(null);

            // Get pending orders
            const pendingOrders = (data?.orders || []).filter(o => o.status === 'pending' && !o.route_id);

            // Initialize map
            useEffect(() => {
                if (!mapRef.current || mapInstance.current) return;

                // Find company headquarters (first DC or primary DC)
                const headquarters = (data?.distributionCenters || []).find(dc => dc.is_headquarters || dc.is_primary) 
                    || (data?.distributionCenters || [])[0];
                
                const hqLat = headquarters?.lat ? parseFloat(headquarters.lat) : 39.8283;
                const hqLng = headquarters?.lng ? parseFloat(headquarters.lng) : -98.5795;
                const hasHQ = headquarters?.lat && headquarters?.lng;

                const map = new google.maps.Map(mapRef.current, {
                    center: { lat: hqLat, lng: hqLng },
                    zoom: hasHQ ? 8 : 4,
                    mapTypeControl: true,
                    streetViewControl: true,
                    fullscreenControl: true
                });
                mapInstance.current = map;

                // Add 500 mile radius circle around HQ
                if (hasHQ) {
                    const radiusInMeters = 500 * 1609.34; // 500 miles to meters
                    const serviceCircle = new google.maps.Circle({
                        map: map,
                        center: { lat: hqLat, lng: hqLng },
                        radius: radiusInMeters,
                        fillColor: '#6366F1',
                        fillOpacity: 0.08,
                        strokeColor: '#6366F1',
                        strokeOpacity: 0.4,
                        strokeWeight: 2
                    });
                    map.fitBounds(serviceCircle.getBounds());
                }

                // Initialize directions renderer for route display
                directionsRendererRef.current = new google.maps.DirectionsRenderer({
                    map: map,
                    suppressMarkers: true, // We'll add our own numbered markers
                    polylineOptions: {
                        strokeColor: '#6366F1',
                        strokeWeight: 4,
                        strokeOpacity: 0.8
                    }
                });

                return () => {
                    markersRef.current.forEach(m => m.setMap(null));
                    markersRef.current = [];
                    if (directionsRendererRef.current) directionsRendererRef.current.setMap(null);
                    mapInstance.current = null;
                };
            }, []);

            // Update map when optimized route changes
            useEffect(() => {
                if (!mapInstance.current) return;
                const map = mapInstance.current;

                // Clear existing markers
                markersRef.current.forEach(m => m.setMap(null));
                markersRef.current = [];
                if (polylineRef.current) {
                    polylineRef.current.setMap(null);
                    polylineRef.current = null;
                }
                if (directionsRendererRef.current) {
                    directionsRendererRef.current.setDirections({ routes: [] });
                }

                if (optimizedRoute) {
                    const bounds = new google.maps.LatLngBounds();

                    // Add depot marker
                    const depot = optimizedRoute.depot;
                    const depotMarker = new google.maps.Marker({
                        position: { lat: depot.lat, lng: depot.lng },
                        map: map,
                        title: depot.name,
                        icon: {
                            url: 'data:image/svg+xml,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="#6366F1"><path d="M12 2L2 7v10l10 5 10-5V7L12 2zm0 2.18l6.9 3.45L12 11.09 5.1 7.63 12 4.18zM4 8.72l7 3.5v7.06l-7-3.5V8.72zm9 10.56V12.22l7-3.5v7.06l-7 3.5z"/></svg>'),
                            scaledSize: new google.maps.Size(32, 32),
                            anchor: new google.maps.Point(16, 16)
                        }
                    });
                    const depotInfo = new google.maps.InfoWindow({
                        content: `<div style="color:#333"><b>üè≠ ${depot.name}</b><br/>Start/End Point</div>`
                    });
                    depotMarker.addListener('click', () => depotInfo.open(map, depotMarker));
                    markersRef.current.push(depotMarker);
                    bounds.extend(depotMarker.getPosition());

                    // Add stop markers with numbers
                    optimizedRoute.stops.forEach((stop, idx) => {
                        const marker = new google.maps.Marker({
                            position: { lat: stop.lat, lng: stop.lng },
                            map: map,
                            title: stop.name,
                            label: {
                                text: String(idx + 1),
                                color: 'white',
                                fontWeight: 'bold',
                                fontSize: '12px'
                            },
                            icon: {
                                path: google.maps.SymbolPath.CIRCLE,
                                scale: 14,
                                fillColor: '#6366F1',
                                fillOpacity: 1,
                                strokeColor: '#ffffff',
                                strokeWeight: 2
                            }
                        });
                        const infoWindow = new google.maps.InfoWindow({
                            content: `<div style="color:#333"><b>Stop ${idx + 1}: ${stop.name}</b><br/>${stop.address || ''}<br/>${stop.city}, ${stop.state}<br/>Gallons: ${stop.gallons || '-'}</div>`
                        });
                        marker.addListener('click', () => infoWindow.open(map, marker));
                        markersRef.current.push(marker);
                        bounds.extend(marker.getPosition());
                    });

                    // Draw route using Directions API for real roads
                    if (optimizedRoute.stops.length > 0) {
                        const directionsService = new google.maps.DirectionsService();
                        const waypoints = optimizedRoute.stops.slice(0, -1).map(stop => ({
                            location: { lat: stop.lat, lng: stop.lng },
                            stopover: true
                        }));
                        
                        const lastStop = optimizedRoute.stops[optimizedRoute.stops.length - 1];
                        
                        directionsService.route({
                            origin: { lat: depot.lat, lng: depot.lng },
                            destination: { lat: depot.lat, lng: depot.lng }, // Return to depot
                            waypoints: optimizedRoute.stops.map(stop => ({
                                location: { lat: stop.lat, lng: stop.lng },
                                stopover: true
                            })),
                            optimizeWaypoints: false, // We already optimized
                            travelMode: google.maps.TravelMode.DRIVING
                        }, (result, status) => {
                            if (status === 'OK') {
                                directionsRendererRef.current.setDirections(result);
                            } else {
                                // Fallback to simple polyline if directions fail
                                const routeCoords = [
                                    { lat: depot.lat, lng: depot.lng },
                                    ...optimizedRoute.stops.map(s => ({ lat: s.lat, lng: s.lng })),
                                    { lat: depot.lat, lng: depot.lng }
                                ];
                                polylineRef.current = new google.maps.Polyline({
                                    path: routeCoords,
                                    strokeColor: '#6366F1',
                                    strokeWeight: 4,
                                    strokeOpacity: 0.8,
                                    map: map
                                });
                            }
                        });
                    }

                    map.fitBounds(bounds);
                } else if (selectedDC) {
                    // Show DC and selected orders on map
                    const dc = data?.distributionCenters?.find(d => d.id === selectedDC);
                    if (dc?.lat && dc?.lng) {
                        const bounds = new google.maps.LatLngBounds();
                        
                        const depotMarker = new google.maps.Marker({
                            position: { lat: parseFloat(dc.lat), lng: parseFloat(dc.lng) },
                            map: map,
                            title: dc.name,
                            icon: {
                                url: 'data:image/svg+xml,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="#6366F1"><path d="M12 2L2 7v10l10 5 10-5V7L12 2z"/></svg>'),
                                scaledSize: new google.maps.Size(32, 32),
                                anchor: new google.maps.Point(16, 16)
                            }
                        });
                        const depotInfo = new google.maps.InfoWindow({
                            content: `<div style="color:#333"><b>üè≠ ${dc.name}</b></div>`
                        });
                        depotMarker.addListener('click', () => depotInfo.open(map, depotMarker));
                        markersRef.current.push(depotMarker);
                        bounds.extend(depotMarker.getPosition());

                        // Show selected orders
                        selectedOrders.forEach(orderId => {
                            const order = pendingOrders.find(o => o.id === orderId);
                            if (order?.lat && order?.lng) {
                                const marker = new google.maps.Marker({
                                    position: { lat: parseFloat(order.lat), lng: parseFloat(order.lng) },
                                    map: map,
                                    title: order.customer_name,
                                    icon: {
                                        path: google.maps.SymbolPath.CIRCLE,
                                        scale: 10,
                                        fillColor: '#F59E0B',
                                        fillOpacity: 1,
                                        strokeColor: '#ffffff',
                                        strokeWeight: 2
                                    }
                                });
                                const infoWindow = new google.maps.InfoWindow({
                                    content: `<div style="color:#333"><b>${order.customer_name}</b><br/>${order.gallons_requested} gal</div>`
                                });
                                marker.addListener('click', () => infoWindow.open(map, marker));
                                markersRef.current.push(marker);
                                bounds.extend(marker.getPosition());
                            }
                        });

                        if (markersRef.current.length > 0) {
                            map.fitBounds(bounds);
                        }
                    }
                }
            }, [optimizedRoute, selectedDC, selectedOrders, data]);

            const handleToggleOrder = (orderId) => {
                setSelectedOrders(prev => 
                    prev.includes(orderId) 
                        ? prev.filter(id => id !== orderId)
                        : [...prev, orderId]
                );
                setOptimizedRoute(null); // Clear optimization when selection changes
            };

            const handleSelectAll = () => {
                if (!selectedDC) return;
                const dcOrders = pendingOrders.filter(o => o.dc_id === selectedDC);
                setSelectedOrders(dcOrders.map(o => o.id));
                setOptimizedRoute(null);
            };

            const handleClearAll = () => {
                setSelectedOrders([]);
                setOptimizedRoute(null);
            };

            const handleOptimize = async () => {
                if (!selectedDC) {
                    setError('Please select a distribution center');
                    return;
                }
                if (selectedOrders.length < 2) {
                    setError('Please select at least 2 orders to optimize');
                    return;
                }

                setLoading(true);
                setError('');

                try {
                    const result = await api.request('/optimize-route', {
                        method: 'POST',
                        body: JSON.stringify({
                            dc_id: selectedDC,
                            order_ids: selectedOrders,
                            truck_id: selectedTruck || null,
                            fuel_price: fuelPrice
                        })
                    });
                    setOptimizedRoute(result);
                } catch (err) {
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            };

            const handleSaveRoute = async () => {
                if (!optimizedRoute) return;

                setLoading(true);
                setError('');

                try {
                    // Create the route
                    const routeResult = await api.request('/data/routes', {
                        method: 'POST',
                        body: JSON.stringify({
                            name: routeName || `Optimized Route ${scheduledDate}`,
                            dc_id: selectedDC,
                            truck_id: selectedTruck || null,
                            driver_id: null,
                            scheduled_date: scheduledDate,
                            start_time: '08:00',
                            status: 'planned'
                        })
                    });

                    // Add stops to route
                    const stops = optimizedRoute.stops.map((stop, idx) => ({
                        order_id: stop.order_id,
                        stop_number: idx + 1
                    }));

                    await api.request(`/data/routes/${routeResult.id}/stops`, {
                        method: 'POST',
                        body: JSON.stringify({ orders: stops })
                    });

                    // Update route with optimization data
                    await api.request(`/data/routes/${routeResult.id}`, {
                        method: 'PUT',
                        body: JSON.stringify({
                            ...routeResult,
                            total_miles: optimizedRoute.metrics.totalMiles,
                            estimated_duration: optimizedRoute.metrics.totalTimeMinutes,
                            is_optimized: true
                        })
                    });

                    onRefresh();
                    onBack();
                } catch (err) {
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            };

            const selectedTruckData = data?.trucks?.find(t => t.id === selectedTruck);

            return (
                <>
                    <div className="page-header">
                        <h1 className="page-title">üöÄ Route Builder & Optimizer</h1>
                        <button className="btn btn-secondary" onClick={onBack}>‚Üê Back to Routes</button>
                    </div>

                    {error && <div className="error-message" style={{marginBottom:'1rem'}}>{error}</div>}

                    <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:'1.5rem'}}>
                        {/* Left Panel - Configuration */}
                        <div>
                            <div className="card">
                                <div className="card-header"><h3>‚öôÔ∏è Route Configuration</h3></div>
                                <div className="card-body">
                                    <div className="form-group">
                                        <label className="form-label">Distribution Center *</label>
                                        <select className="form-input" value={selectedDC} onChange={(e) => { setSelectedDC(e.target.value); setOptimizedRoute(null); }}>
                                            <option value="">Select DC...</option>
                                            {(data?.distributionCenters || []).map(dc => (
                                                <option key={dc.id} value={dc.id}>{dc.name} - {dc.city}, {dc.state}</option>
                                            ))}
                                        </select>
                                    </div>
                                    <div className="form-row">
                                        <div className="form-group">
                                            <label className="form-label">Truck</label>
                                            <select className="form-input" value={selectedTruck} onChange={(e) => { setSelectedTruck(e.target.value); setOptimizedRoute(null); }}>
                                                <option value="">Select Truck...</option>
                                                {(data?.trucks || []).filter(t => !selectedDC || t.dc_id === selectedDC).map(t => (
                                                    <option key={t.id} value={t.id}>{t.code} - {t.name || `${t.make} ${t.model}`} ({t.mpg || 8} MPG)</option>
                                                ))}
                                            </select>
                                        </div>
                                        <div className="form-group">
                                            <label className="form-label">Fuel Price ($/gal)</label>
                                            <input type="number" className="form-input" step="0.01" value={fuelPrice} onChange={(e) => setFuelPrice(parseFloat(e.target.value) || 3.50)} />
                                        </div>
                                    </div>
                                    <div className="form-row">
                                        <div className="form-group">
                                            <label className="form-label">Route Name</label>
                                            <input type="text" className="form-input" value={routeName} onChange={(e) => setRouteName(e.target.value)} placeholder="Morning Deliveries" />
                                        </div>
                                        <div className="form-group">
                                            <label className="form-label">Scheduled Date</label>
                                            <input type="date" className="form-input" value={scheduledDate} onChange={(e) => setScheduledDate(e.target.value)} />
                                        </div>
                                    </div>
                                </div>
                            </div>

                            {/* Orders Selection */}
                            <div className="card">
                                <div className="card-header">
                                    <h3>üì¶ Select Orders ({selectedOrders.length} selected)</h3>
                                    <div style={{display:'flex',gap:'0.5rem'}}>
                                        <button className="btn btn-sm btn-secondary" onClick={handleSelectAll}>Select All</button>
                                        <button className="btn btn-sm btn-secondary" onClick={handleClearAll}>Clear</button>
                                    </div>
                                </div>
                                <div style={{maxHeight:'300px',overflow:'auto'}}>
                                    {!selectedDC ? (
                                        <div className="text-muted" style={{textAlign:'center',padding:'2rem'}}>
                                            ‚¨ÜÔ∏è Select a Distribution Center to see orders
                                        </div>
                                    ) : (
                                        <table>
                                            <thead><tr><th style={{width:'40px'}}></th><th>Order</th><th>Customer</th><th>Gallons</th><th>City</th><th>DC</th></tr></thead>
                                            <tbody>
                                                {pendingOrders.filter(o => o.dc_id === selectedDC).map(order => (
                                                    <tr key={order.id} style={{cursor:'pointer'}} onClick={() => handleToggleOrder(order.id)}>
                                                        <td>
                                                            <input type="checkbox" checked={selectedOrders.includes(order.id)} onChange={() => {}} style={{width:'18px',height:'18px'}} />
                                                        </td>
                                                        <td><strong>{order.order_number}</strong></td>
                                                        <td>{order.customer_name}</td>
                                                        <td>{order.gallons_requested}</td>
                                                        <td>{order.customer_city}</td>
                                                        <td style={{fontSize:'0.8rem'}}>{order.dc_name || '‚Äî'}</td>
                                                    </tr>
                                                ))}
                                                {pendingOrders.filter(o => o.dc_id === selectedDC).length === 0 && (
                                                    <tr><td colSpan="6" className="text-muted" style={{textAlign:'center',padding:'2rem'}}>No pending orders for this DC</td></tr>
                                                )}
                                            </tbody>
                                        </table>
                                    )}
                                    {selectedDC && pendingOrders.filter(o => !o.dc_id).length > 0 && (
                                        <div style={{padding:'0.5rem',background:'rgba(245,158,11,0.1)',borderRadius:'4px',margin:'0.5rem',fontSize:'0.85rem',color:'var(--warning)'}}>
                                            ‚ö†Ô∏è {pendingOrders.filter(o => !o.dc_id).length} orders have no DC assigned
                                        </div>
                                    )}
                                </div>
                            </div>

                            {/* Optimize Button */}
                            <button 
                                className="btn btn-success btn-block" 
                                onClick={handleOptimize}
                                disabled={loading || selectedOrders.length < 2 || !selectedDC}
                                style={{marginBottom:'1rem',padding:'1rem',fontSize:'1.1rem'}}
                            >
                                {loading ? '‚è≥ Optimizing...' : 'üöÄ Optimize Route'}
                            </button>
                        </div>

                        {/* Right Panel - Map & Results */}
                        <div>
                            {/* Map */}
                            <div className="card">
                                <div className="card-header"><h3>üó∫Ô∏è Route Map</h3></div>
                                <div style={{height:'350px'}}>
                                    <div ref={mapRef} style={{height:'100%',width:'100%',borderRadius:'0 0 12px 12px'}}></div>
                                </div>
                            </div>

                            {/* Optimization Results */}
                            {optimizedRoute && (
                                <div className="card" style={{borderColor:'var(--success)'}}>
                                    <div className="card-header" style={{background:'rgba(16,185,129,0.1)'}}>
                                        <h3 style={{color:'var(--success)'}}>‚úÖ Route Optimized!</h3>
                                        {optimizedRoute.savings.percentage > 0 && (
                                            <span style={{color:'var(--success)',fontWeight:'600'}}>
                                                {optimizedRoute.savings.percentage}% shorter
                                            </span>
                                        )}
                                    </div>
                                    <div className="card-body">
                                        <div className="stats-grid" style={{marginBottom:'1rem'}}>
                                            <div className="stat-card">
                                                <div className="stat-card-value">{optimizedRoute.metrics.totalMiles}</div>
                                                <div className="stat-card-label">Miles</div>
                                            </div>
                                            <div className="stat-card">
                                                <div className="stat-card-value">${optimizedRoute.metrics.fuelCost.toFixed(2)}</div>
                                                <div className="stat-card-label">Fuel Cost</div>
                                            </div>
                                            <div className="stat-card">
                                                <div className="stat-card-value">{optimizedRoute.metrics.totalTimeFormatted}</div>
                                                <div className="stat-card-label">Total Time</div>
                                            </div>
                                            <div className="stat-card">
                                                <div className="stat-card-value">{optimizedRoute.metrics.numStops}</div>
                                                <div className="stat-card-label">Stops</div>
                                            </div>
                                        </div>

                                        {optimizedRoute.savings.miles > 0 && (
                                            <div style={{background:'rgba(16,185,129,0.1)',padding:'1rem',borderRadius:'8px',marginBottom:'1rem'}}>
                                                <div style={{fontWeight:'600',color:'var(--success)',marginBottom:'0.5rem'}}>üí∞ Savings vs. Unoptimized</div>
                                                <div style={{display:'flex',gap:'1.5rem',fontSize:'0.9rem'}}>
                                                    <span>{optimizedRoute.savings.miles.toFixed(1)} miles saved</span>
                                                    <span>${optimizedRoute.savings.fuel_cost.toFixed(2)} fuel saved</span>
                                                    <span>{optimizedRoute.savings.time_minutes} min saved</span>
                                                </div>
                                            </div>
                                        )}

                                        <div style={{marginBottom:'1rem'}}>
                                            <strong>Optimized Stop Order:</strong>
                                            <div style={{marginTop:'0.5rem',fontSize:'0.9rem'}}>
                                                <span style={{color:'var(--success)'}}>üè≠ Start</span>
                                                {optimizedRoute.stops.map((stop, idx) => (
                                                    <span key={idx}> ‚Üí <strong>{idx + 1}.</strong> {stop.name}</span>
                                                ))}
                                                <span> ‚Üí <span style={{color:'var(--success)'}}>üè≠ End</span></span>
                                            </div>
                                        </div>

                                        <button 
                                            className="btn btn-primary btn-block" 
                                            onClick={handleSaveRoute}
                                            disabled={loading}
                                            style={{padding:'1rem'}}
                                        >
                                            {loading ? 'Saving...' : 'üíæ Save Optimized Route'}
                                        </button>
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                </>
            );
        }

        // =====================================================
        // TRUCKS VIEW - Comprehensive Profiles
        // =====================================================
        function TrucksView({ data, onRefresh }) {
            const [showModal, setShowModal] = useState(false);
            const [editItem, setEditItem] = useState(null);
            const [viewItem, setViewItem] = useState(null);
            const [loading, setLoading] = useState(false);
            const [activeTab, setActiveTab] = useState('basic');

            const dcOptions = (data?.distributionCenters || []).map(dc => ({ value: dc.id, label: dc.name }));
            const driverOptions = (data?.drivers || []).map(d => ({ value: d.id, label: `${d.code} - ${d.name}` }));

            // Calculate load capacity
            const calculateLoadCapacity = (truck) => {
                if (!truck.max_payload || !truck.product_weight_per_gallon) return truck.capacity_gallons;
                const dieselWeight = (truck.fuel_tank_capacity || 100) * (truck.diesel_weight_per_gallon || 7.1);
                const maxProductWeight = truck.max_payload - dieselWeight;
                const maxGallons = Math.floor(maxProductWeight / truck.product_weight_per_gallon);
                return Math.min(maxGallons, truck.capacity_gallons || 3000);
            };

            const getBasicFields = () => [
                { type: 'row', fields: [
                    { name: 'code', label: 'Truck Code', required: true, placeholder: 'TRK-001' },
                    { name: 'name', label: 'Truck Name', placeholder: 'Propane Truck 1' }
                ]},
                { name: 'dc_id', label: 'Distribution Center', type: 'select', options: dcOptions },
                { name: 'assigned_driver_id', label: 'Assigned Driver', type: 'select', options: driverOptions },
                { type: 'row3', fields: [
                    { name: 'make', label: 'Make', placeholder: 'Freightliner' },
                    { name: 'model', label: 'Model', placeholder: 'M2 106' },
                    { name: 'year', label: 'Year', type: 'number' }
                ]},
                { type: 'row', fields: [
                    { name: 'vin', label: 'VIN' },
                    { name: 'license_plate', label: 'License Plate' }
                ]},
                { name: 'status', label: 'Status', type: 'select', options: [
                    { value: 'active', label: 'Active' },
                    { value: 'maintenance', label: 'Maintenance' },
                    { value: 'inactive', label: 'Inactive' }
                ]}
            ];

            const getWeightFields = () => [
                { type: 'row3', fields: [
                    { name: 'gvwr', label: 'GVWR (lbs)', type: 'number', placeholder: '26000' },
                    { name: 'empty_weight', label: 'Empty Weight (lbs)', type: 'number', placeholder: '14000' },
                    { name: 'max_payload', label: 'Max Payload (lbs)', type: 'number', placeholder: '12000' }
                ]},
                { type: 'row3', fields: [
                    { name: 'front_axle_weight', label: 'Front Axle Weight', type: 'number' },
                    { name: 'rear_axle_weight', label: 'Rear Axle Weight', type: 'number' },
                    { name: 'axle_configuration', label: 'Axle Config', type: 'select', options: [
                        { value: 'single', label: 'Single' },
                        { value: 'tandem', label: 'Tandem' },
                        { value: 'tridem', label: 'Tridem' }
                    ]}
                ]},
                { type: 'row', fields: [
                    { name: 'product_weight_per_gallon', label: 'Product Weight (lbs/gal)', type: 'number', step: '0.01', placeholder: '4.20' },
                    { name: 'diesel_weight_per_gallon', label: 'Diesel Weight (lbs/gal)', type: 'number', step: '0.01', placeholder: '7.10' }
                ]}
            ];

            const getTankFields = () => [
                { type: 'row', fields: [
                    { name: 'capacity_gallons', label: 'Tank Capacity (gal)', type: 'number', placeholder: '3000' },
                    { name: 'tank_material', label: 'Tank Material', type: 'select', options: [
                        { value: 'steel', label: 'Steel' },
                        { value: 'aluminum', label: 'Aluminum' }
                    ]}
                ]},
                { type: 'row', fields: [
                    { name: 'tank_manufacturer', label: 'Tank Manufacturer' },
                    { name: 'tank_serial_number', label: 'Tank Serial #' }
                ]},
                { type: 'row', fields: [
                    { name: 'tank_manufacture_date', label: 'Tank Mfg Date', type: 'date' },
                    { name: 'working_pressure_psi', label: 'Working Pressure (PSI)', type: 'number' }
                ]},
                { type: 'row', fields: [
                    { name: 'tank_last_inspection', label: 'Last Tank Inspection', type: 'date' },
                    { name: 'tank_next_inspection', label: 'Next Tank Inspection', type: 'date' }
                ]},
                { type: 'row', fields: [
                    { name: 'meter_serial_number', label: 'Meter Serial #' },
                    { name: 'meter_last_calibration', label: 'Meter Last Calibration', type: 'date' }
                ]}
            ];

            const getFuelFields = () => [
                { type: 'row3', fields: [
                    { name: 'fuel_tank_capacity', label: 'Fuel Tank (gal)', type: 'number', placeholder: '100' },
                    { name: 'mpg', label: 'Fuel Economy (MPG)', type: 'number', step: '0.1', placeholder: '8' },
                    { name: 'fuel_type', label: 'Fuel Type', type: 'select', options: [
                        { value: 'diesel', label: 'Diesel' },
                        { value: 'gasoline', label: 'Gasoline' },
                        { value: 'cng', label: 'CNG' }
                    ]}
                ]},
                { name: 'def_tank_capacity', label: 'DEF Tank Capacity (gal)', type: 'number' }
            ];

            const getComplianceFields = () => [
                { type: 'row', fields: [
                    { name: 'registration_number', label: 'Registration #' },
                    { name: 'registration_state', label: 'Registration State' }
                ]},
                { name: 'registration_expiration', label: 'Registration Expiry', type: 'date' },
                { type: 'row', fields: [
                    { name: 'dot_number', label: 'DOT Number' },
                    { name: 'mc_number', label: 'MC Number' }
                ]},
                { type: 'row', fields: [
                    { name: 'ifta_account', label: 'IFTA Account' },
                    { name: 'irp_account', label: 'IRP Account' }
                ]},
                { type: 'row', fields: [
                    { name: 'last_dot_inspection', label: 'Last DOT Inspection', type: 'date' },
                    { name: 'next_dot_inspection', label: 'Next DOT Inspection', type: 'date' }
                ]},
                { type: 'row', fields: [
                    { name: 'dot_inspection_result', label: 'Inspection Result', type: 'select', options: [
                        { value: 'passed', label: 'Passed' },
                        { value: 'failed', label: 'Failed' },
                        { value: 'oos', label: 'Out of Service' }
                    ]},
                    { name: 'inspection_decal_number', label: 'Inspection Decal #' }
                ]}
            ];

            const getInsuranceFields = () => [
                { name: 'insurance_carrier', label: 'Insurance Carrier' },
                { type: 'row', fields: [
                    { name: 'insurance_policy_number', label: 'Policy Number' },
                    { name: 'insurance_expiry', label: 'Insurance Expiry', type: 'date' }
                ]},
                { type: 'row', fields: [
                    { name: 'liability_coverage', label: 'Liability Coverage ($)', type: 'number' },
                    { name: 'cargo_coverage', label: 'Cargo Coverage ($)', type: 'number' }
                ]}
            ];

            const getMaintenanceFields = () => [
                { type: 'row', fields: [
                    { name: 'current_odometer', label: 'Current Odometer', type: 'number' },
                    { name: 'total_hours', label: 'Total Hours', type: 'number', step: '0.1' }
                ]},
                { type: 'row', fields: [
                    { name: 'last_service_date', label: 'Last Service Date', type: 'date' },
                    { name: 'last_service_mileage', label: 'Last Service Mileage', type: 'number' }
                ]},
                { type: 'row', fields: [
                    { name: 'next_service_date', label: 'Next Service Due', type: 'date' },
                    { name: 'next_service_mileage', label: 'Next Service Mileage', type: 'number' }
                ]},
                { name: 'oil_change_interval_miles', label: 'Oil Change Interval (miles)', type: 'number', placeholder: '15000' },
                { type: 'row', fields: [
                    { name: 'tire_type', label: 'Tire Type' },
                    { name: 'tire_size', label: 'Tire Size' }
                ]}
            ];

            const getEquipmentFields = () => [
                { type: 'row', fields: [
                    { name: 'has_lift_gate', label: 'Has Lift Gate', type: 'checkbox' },
                    { name: 'has_pto_pump', label: 'Has PTO Pump', type: 'checkbox' }
                ]},
                { type: 'row', fields: [
                    { name: 'has_gps_tracker', label: 'GPS Tracker', type: 'checkbox' },
                    { name: 'has_dash_cam', label: 'Dash Cam', type: 'checkbox' }
                ]},
                { type: 'row', fields: [
                    { name: 'has_eld', label: 'ELD Installed', type: 'checkbox' },
                    { name: 'eld_provider', label: 'ELD Provider' }
                ]},
                { name: 'eld_serial_number', label: 'ELD Serial Number' }
            ];

            const getCostFields = () => [
                { type: 'row', fields: [
                    { name: 'purchase_date', label: 'Purchase Date', type: 'date' },
                    { name: 'purchase_price', label: 'Purchase Price ($)', type: 'number', step: '0.01' }
                ]},
                { type: 'row', fields: [
                    { name: 'current_value', label: 'Current Value ($)', type: 'number', step: '0.01' },
                    { name: 'monthly_payment', label: 'Monthly Payment ($)', type: 'number', step: '0.01' }
                ]},
                { name: 'monthly_insurance', label: 'Monthly Insurance ($)', type: 'number', step: '0.01' },
                { name: 'notes', label: 'Notes', type: 'textarea' }
            ];

            const getFieldsForTab = () => {
                switch (activeTab) {
                    case 'basic': return getBasicFields();
                    case 'weight': return getWeightFields();
                    case 'tank': return getTankFields();
                    case 'fuel': return getFuelFields();
                    case 'compliance': return getComplianceFields();
                    case 'insurance': return getInsuranceFields();
                    case 'maintenance': return getMaintenanceFields();
                    case 'equipment': return getEquipmentFields();
                    case 'cost': return getCostFields();
                    default: return getBasicFields();
                }
            };

            const handleSave = async (formData) => {
                setLoading(true);
                try {
                    if (editItem) {
                        await api.request(`/data/trucks/${editItem.id}`, { method: 'PUT', body: JSON.stringify(formData) });
                    } else {
                        await api.request('/data/trucks', { method: 'POST', body: JSON.stringify(formData) });
                    }
                    setShowModal(false);
                    setEditItem(null);
                    onRefresh();
                } finally {
                    setLoading(false);
                }
            };

            const handleDelete = async (id) => {
                if (!confirm('Delete this truck?')) return;
                await api.request(`/data/trucks/${id}`, { method: 'DELETE' });
                onRefresh();
            };

            const tabs = [
                { id: 'basic', label: 'üìã Basic Info' },
                { id: 'weight', label: '‚öñÔ∏è Weight' },
                { id: 'tank', label: 'üõ¢Ô∏è Tank' },
                { id: 'fuel', label: '‚õΩ Fuel' },
                { id: 'compliance', label: 'üìú Compliance' },
                { id: 'insurance', label: 'üõ°Ô∏è Insurance' },
                { id: 'maintenance', label: 'üîß Maintenance' },
                { id: 'equipment', label: 'üîå Equipment' },
                { id: 'cost', label: 'üí∞ Costs' }
            ];

            // Truck Detail View
            if (viewItem) {
                const maxLoad = calculateLoadCapacity(viewItem);
                return (
                    <>
                        <div className="page-header">
                            <h1 className="page-title">üöö {viewItem.name || viewItem.code}</h1>
                            <div style={{display:'flex',gap:'0.5rem'}}>
                                <button className="btn btn-secondary" onClick={() => { setEditItem(viewItem); setViewItem(null); setShowModal(true); }}>Edit</button>
                                <button className="btn btn-secondary" onClick={() => setViewItem(null)}>‚Üê Back</button>
                            </div>
                        </div>
                        <div className="stats-grid">
                            <div className="stat-card">
                                <div className="stat-card-icon">üõ¢Ô∏è</div>
                                <div className="stat-card-value">{(viewItem.capacity_gallons || 0).toLocaleString()}</div>
                                <div className="stat-card-label">Tank Capacity (gal)</div>
                            </div>
                            <div className="stat-card">
                                <div className="stat-card-icon">‚öñÔ∏è</div>
                                <div className="stat-card-value">{maxLoad.toLocaleString()}</div>
                                <div className="stat-card-label">Max Safe Load (gal)</div>
                            </div>
                            <div className="stat-card">
                                <div className="stat-card-icon">‚õΩ</div>
                                <div className="stat-card-value">{viewItem.mpg || 8}</div>
                                <div className="stat-card-label">MPG</div>
                            </div>
                            <div className="stat-card">
                                <div className="stat-card-icon">üìä</div>
                                <div className="stat-card-value">{(viewItem.odometer || 0).toLocaleString()}</div>
                                <div className="stat-card-label">Odometer</div>
                            </div>
                        </div>
                        <div className="grid-2">
                            <div className="card">
                                <div className="card-header"><h3>üìã Vehicle Info</h3></div>
                                <div className="card-body">
                                    <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:'1rem',fontSize:'0.9rem'}}>
                                        <div><strong>Code:</strong> {viewItem.code}</div>
                                        <div><strong>VIN:</strong> {viewItem.vin || '-'}</div>
                                        <div><strong>Make:</strong> {viewItem.make || '-'}</div>
                                        <div><strong>Model:</strong> {viewItem.model || '-'}</div>
                                        <div><strong>Year:</strong> {viewItem.year || '-'}</div>
                                        <div><strong>License Plate:</strong> {viewItem.license_plate || '-'}</div>
                                        <div><strong>Status:</strong> <span className={`status-badge status-${viewItem.status}`}>{viewItem.status}</span></div>
                                        <div><strong>DC:</strong> {viewItem.dc_name || '-'}</div>
                                    </div>
                                </div>
                            </div>
                            <div className="card">
                                <div className="card-header"><h3>‚öñÔ∏è Weight Specifications</h3></div>
                                <div className="card-body">
                                    <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:'1rem',fontSize:'0.9rem'}}>
                                        <div><strong>GVWR:</strong> {viewItem.gvwr ? `${viewItem.gvwr.toLocaleString()} lbs` : '-'}</div>
                                        <div><strong>Tare Weight:</strong> {viewItem.tare_weight ? `${viewItem.tare_weight.toLocaleString()} lbs` : '-'}</div>
                                        <div><strong>Payload:</strong> {viewItem.max_payload ? `${viewItem.max_payload.toLocaleString()} lbs` : '-'}</div>
                                        <div><strong>Product Weight:</strong> {viewItem.product_weight_per_gallon || 4.2} lbs/gal</div>
                                        <div><strong>Diesel Weight:</strong> {viewItem.diesel_weight_per_gallon || 7.1} lbs/gal</div>
                                        <div><strong>Axle Config:</strong> {viewItem.axle_configuration || '-'}</div>
                                    </div>
                                </div>
                            </div>
                            <div className="card">
                                <div className="card-header"><h3>üìú Compliance Status</h3></div>
                                <div className="card-body">
                                    <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:'1rem',fontSize:'0.9rem'}}>
                                        <div><strong>Registration:</strong> {viewItem.registration_expiration || '-'} {viewItem.registration_expiration && new Date(viewItem.registration_expiration) < new Date() && <span style={{color:'var(--danger)'}}>‚ö†Ô∏è EXPIRED</span>}</div>
                                        <div><strong>DOT Inspection:</strong> {viewItem.next_dot_inspection || '-'} {viewItem.next_dot_inspection && new Date(viewItem.next_dot_inspection) < new Date() && <span style={{color:'var(--danger)'}}>‚ö†Ô∏è DUE</span>}</div>
                                        <div><strong>Insurance:</strong> {viewItem.insurance_expiration || '-'} {viewItem.insurance_expiration && new Date(viewItem.insurance_expiration) < new Date() && <span style={{color:'var(--danger)'}}>‚ö†Ô∏è EXPIRED</span>}</div>
                                        <div><strong>Tank Inspection:</strong> {viewItem.tank_next_inspection || '-'}</div>
                                    </div>
                                </div>
                            </div>
                            <div className="card">
                                <div className="card-header"><h3>üîß Maintenance</h3></div>
                                <div className="card-body">
                                    <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:'1rem',fontSize:'0.9rem'}}>
                                        <div><strong>Last Service:</strong> {viewItem.last_service_date || '-'}</div>
                                        <div><strong>At Mileage:</strong> {viewItem.last_oil_change_miles ? viewItem.last_oil_change_miles.toLocaleString() : '-'}</div>
                                        <div><strong>Next Service:</strong> {viewItem.next_service_date || '-'}</div>
                                        <div><strong>Next Oil Change:</strong> {viewItem.next_oil_change_miles ? `${viewItem.next_oil_change_miles.toLocaleString()} mi` : '-'}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </>
                );
            }

            return (
                <>
                    <div className="page-header">
                        <h1 className="page-title">üöö Trucks</h1>
                        <button className="btn btn-primary" onClick={() => { setEditItem(null); setActiveTab('basic'); setShowModal(true); }}>+ Add Truck</button>
                    </div>
                    <div className="table-container">
                        <table>
                            <thead><tr><th>Code</th><th>Name</th><th>Make/Model</th><th>Capacity</th><th>MPG</th><th>DOT Due</th><th>Status</th><th>Actions</th></tr></thead>
                            <tbody>
                                {(data?.trucks || []).map(item => (
                                    <tr key={item.id}>
                                        <td><strong style={{cursor:'pointer',color:'var(--primary)'}} onClick={() => setViewItem(item)}>{item.code}</strong></td>
                                        <td>{item.name || '-'}</td>
                                        <td>{item.make} {item.model} {item.year}</td>
                                        <td>{(item.capacity_gallons || 0).toLocaleString()} gal</td>
                                        <td>{item.mpg || '-'}</td>
                                        <td>{item.next_dot_inspection ? <span style={{color: new Date(item.next_dot_inspection) < new Date() ? 'var(--danger)' : 'inherit'}}>{item.next_dot_inspection}</span> : '-'}</td>
                                        <td><span className={`status-badge status-${item.status}`}>{item.status}</span></td>
                                        <td>
                                            <div className="action-buttons">
                                                <button className="btn btn-sm btn-secondary" onClick={() => setViewItem(item)}>View</button>
                                                <button className="btn btn-sm btn-secondary" onClick={() => { setEditItem(item); setActiveTab('basic'); setShowModal(true); }}>Edit</button>
                                                <button className="btn btn-sm btn-danger" onClick={() => handleDelete(item.id)}>Delete</button>
                                            </div>
                                        </td>
                                    </tr>
                                ))}
                                {(!data?.trucks || data.trucks.length === 0) && (
                                    <tr><td colSpan="8" className="empty-state">No trucks yet. Click "Add Truck" to create one.</td></tr>
                                )}
                            </tbody>
                        </table>
                    </div>
                    {showModal && (
                        <TruckFormModal
                            editItem={editItem}
                            activeTab={activeTab}
                            setActiveTab={setActiveTab}
                            tabs={tabs}
                            getFieldsForTab={getFieldsForTab}
                            onSave={handleSave}
                            onClose={() => { setShowModal(false); setEditItem(null); }}
                            loading={loading}
                        />
                    )}
                </>
            );
        }

        // Truck Form Modal with stable state management
        function TruckFormModal({ editItem, activeTab, setActiveTab, tabs, getFieldsForTab, onSave, onClose, loading }) {
            const defaultData = { status: 'active', capacity_gallons: 3000, mpg: 8, product_weight_per_gallon: 4.2, diesel_weight_per_gallon: 7.1, fuel_type: 'diesel', has_gps_tracker: true, has_eld: true };
            const [formData, setFormData] = useState(() => editItem ? { ...editItem } : { ...defaultData });
            const [error, setError] = useState('');

            const handleFieldChange = (name, value) => {
                setFormData(prev => ({ ...prev, [name]: value }));
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                setError('');
                try {
                    await onSave(formData);
                } catch (err) {
                    setError(err.message);
                }
            };

            const renderFields = () => {
                const fields = getFieldsForTab();
                return fields.map((field, index) => {
                    if (field.type === 'row') {
                        return (
                            <div key={`row-${index}`} className="form-row">
                                {field.fields.map(f => (
                                    <FormInput key={f.name} name={f.name} label={f.label} type={f.type} value={formData[f.name]} onChange={handleFieldChange} required={f.required} placeholder={f.placeholder} step={f.step} options={f.options} />
                                ))}
                            </div>
                        );
                    }
                    if (field.type === 'row3') {
                        return (
                            <div key={`row3-${index}`} className="form-row-3">
                                {field.fields.map(f => (
                                    <FormInput key={f.name} name={f.name} label={f.label} type={f.type} value={formData[f.name]} onChange={handleFieldChange} required={f.required} placeholder={f.placeholder} step={f.step} options={f.options} />
                                ))}
                            </div>
                        );
                    }
                    return <FormInput key={field.name} name={field.name} label={field.label} type={field.type} value={formData[field.name]} onChange={handleFieldChange} required={field.required} placeholder={field.placeholder} step={field.step} options={field.options} />;
                });
            };

            return (
                <div className="modal-overlay" onClick={(e) => e.target === e.currentTarget && onClose()}>
                    <div className="modal" style={{maxWidth:'1100px',width:'95%',display:'flex',flexDirection:'column',maxHeight:'90vh'}}>
                        <div className="modal-header" style={{flexShrink:0}}>
                            <h3>{editItem ? 'Edit Truck' : 'Add Truck'}</h3>
                            <button className="modal-close" onClick={onClose}>&times;</button>
                        </div>
                        <div style={{padding:'0 1rem',borderBottom:'1px solid var(--border)',display:'flex',gap:'0.25rem',flexWrap:'nowrap',flexShrink:0}}>
                            {tabs.map(tab => (
                                <button key={tab.id} className={`btn btn-sm ${activeTab === tab.id ? 'btn-primary' : 'btn-secondary'}`} style={{borderRadius:'8px 8px 0 0',whiteSpace:'nowrap',fontSize:'0.8rem',padding:'0.5rem 0.75rem'}} onClick={() => setActiveTab(tab.id)}>
                                    {tab.label}
                                </button>
                            ))}
                        </div>
                        <form onSubmit={handleSubmit} style={{display:'flex',flexDirection:'column',flex:1,overflow:'hidden'}}>
                            <div className="modal-body" style={{flex:1,overflowY:'auto',minHeight:'400px'}}>
                                {error && <div className="error-message">{error}</div>}
                                {renderFields()}
                            </div>
                            <div className="modal-footer" style={{flexShrink:0}}>
                                <button type="button" className="btn btn-secondary" onClick={onClose}>Cancel</button>
                                <button type="submit" className="btn btn-primary" disabled={loading}>{loading ? 'Saving...' : 'Save'}</button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }

        // Removed old EntityModalContent - now using TruckFormModal and DriverFormModal

        // =====================================================
        // DRIVERS VIEW - Comprehensive Profiles
        // =====================================================
        function DriversView({ data, onRefresh }) {
            const [showModal, setShowModal] = useState(false);
            const [editItem, setEditItem] = useState(null);
            const [viewItem, setViewItem] = useState(null);
            const [loading, setLoading] = useState(false);
            const [activeTab, setActiveTab] = useState('basic');

            const dcOptions = (data?.distributionCenters || []).map(dc => ({ value: dc.id, label: dc.name }));

            const getBasicFields = () => [
                { type: 'row', fields: [
                    { name: 'code', label: 'Driver Code', required: true, placeholder: 'DRV-001' },
                    { name: 'name', label: 'Full Name', required: true }
                ]},
                { type: 'row', fields: [
                    { name: 'email', label: 'Email', type: 'email' },
                    { name: 'phone', label: 'Phone' }
                ]},
                { name: 'dc_id', label: 'Distribution Center', type: 'select', options: dcOptions },
                { type: 'row', fields: [
                    { name: 'date_of_birth', label: 'Date of Birth', type: 'date' },
                    { name: 'hire_date', label: 'Hire Date', type: 'date' }
                ]},
                { name: 'status', label: 'Status', type: 'select', options: [
                    { value: 'active', label: 'Active' },
                    { value: 'available', label: 'Available' },
                    { value: 'on_route', label: 'On Route' },
                    { value: 'off_duty', label: 'Off Duty' },
                    { value: 'inactive', label: 'Inactive' }
                ]}
            ];

            const getPayFields = () => [
                { type: 'row', fields: [
                    { name: 'pay_type', label: 'Pay Type', type: 'select', options: [
                        { value: 'hourly', label: 'Hourly' },
                        { value: 'salary', label: 'Salary' },
                        { value: 'per_mile', label: 'Per Mile' },
                        { value: 'per_delivery', label: 'Per Delivery' }
                    ]},
                    { name: 'hourly_rate', label: 'Hourly Rate ($)', type: 'number', step: '0.01', placeholder: '25.00' }
                ]},
                { type: 'row', fields: [
                    { name: 'overtime_rate', label: 'Overtime Rate ($)', type: 'number', step: '0.01' },
                    { name: 'per_diem', label: 'Per Diem ($)', type: 'number', step: '0.01' }
                ]},
                { name: 'years_experience', label: 'Years Experience', type: 'number' }
            ];

            const getCDLFields = () => [
                { type: 'row', fields: [
                    { name: 'cdl_number', label: 'CDL Number' },
                    { name: 'cdl_state', label: 'CDL State', placeholder: 'AL' }
                ]},
                { type: 'row', fields: [
                    { name: 'cdl_class', label: 'CDL Class', type: 'select', options: [
                        { value: 'A', label: 'Class A' },
                        { value: 'B', label: 'Class B' },
                        { value: 'C', label: 'Class C' }
                    ]},
                    { name: 'license_expiry', label: 'CDL Expiration', type: 'date' }
                ]},
                { name: 'cdl_endorsements', label: 'Endorsements (comma separated)', placeholder: 'H, N, T, X' },
                { type: 'row', fields: [
                    { name: 'hazmat_endorsed', label: 'HAZMAT Endorsed', type: 'checkbox' },
                    { name: 'hazmat_expiration', label: 'HAZMAT Expiration', type: 'date' }
                ]},
                { type: 'row', fields: [
                    { name: 'tanker_endorsed', label: 'Tanker Endorsed', type: 'checkbox' },
                    { name: 'hazmat_certified', label: 'Propane/HAZMAT Certified', type: 'checkbox' }
                ]},
                { type: 'row', fields: [
                    { name: 'twic_card', label: 'TWIC Card', type: 'checkbox' },
                    { name: 'twic_expiration', label: 'TWIC Expiration', type: 'date' }
                ]}
            ];

            const getMedicalFields = () => [
                { type: 'row', fields: [
                    { name: 'medical_exam_date', label: 'Last Medical Exam', type: 'date' },
                    { name: 'medical_card_expiration', label: 'Medical Card Expires', type: 'date' }
                ]},
                { name: 'medical_examiner_name', label: 'Medical Examiner Name' }
            ];

            const getBackgroundFields = () => [
                { type: 'row', fields: [
                    { name: 'background_check_date', label: 'Background Check Date', type: 'date' },
                    { name: 'background_check_status', label: 'Background Status', type: 'select', options: [
                        { value: 'pending', label: 'Pending' },
                        { value: 'cleared', label: 'Cleared' },
                        { value: 'failed', label: 'Failed' },
                        { value: 'expired', label: 'Expired' }
                    ]}
                ]},
                { type: 'row', fields: [
                    { name: 'drug_test_date', label: 'Last Drug Test', type: 'date' },
                    { name: 'drug_test_status', label: 'Drug Test Status', type: 'select', options: [
                        { value: 'pending', label: 'Pending' },
                        { value: 'passed', label: 'Passed' },
                        { value: 'failed', label: 'Failed' }
                    ]}
                ]},
                { name: 'drug_test_type', label: 'Drug Test Type', type: 'select', options: [
                    { value: 'pre_employment', label: 'Pre-Employment' },
                    { value: 'random', label: 'Random' },
                    { value: 'post_accident', label: 'Post-Accident' },
                    { value: 'reasonable_suspicion', label: 'Reasonable Suspicion' }
                ]},
                { type: 'row', fields: [
                    { name: 'mvr_check_date', label: 'MVR Check Date', type: 'date' },
                    { name: 'mvr_status', label: 'MVR Status', type: 'select', options: [
                        { value: 'pending', label: 'Pending' },
                        { value: 'cleared', label: 'Cleared' },
                        { value: 'issues', label: 'Issues Found' }
                    ]}
                ]}
            ];

            const getTrainingFields = () => [
                { type: 'row', fields: [
                    { name: 'propane_certified', label: 'Propane Certified', type: 'checkbox' },
                    { name: 'propane_cert_expiration', label: 'Propane Cert Expires', type: 'date' }
                ]},
                { type: 'row', fields: [
                    { name: 'defensive_driving_cert', label: 'Defensive Driving', type: 'checkbox' },
                    { name: 'smith_system_trained', label: 'Smith System Trained', type: 'checkbox' }
                ]},
                { name: 'last_training_date', label: 'Last Training Date', type: 'date' }
            ];

            const getEmergencyFields = () => [
                { name: 'emergency_contact_name', label: 'Emergency Contact Name' },
                { type: 'row', fields: [
                    { name: 'emergency_contact_phone', label: 'Emergency Phone' },
                    { name: 'emergency_contact_relation', label: 'Relationship' }
                ]}
            ];

            const getAddressFields = () => [
                { name: 'address', label: 'Street Address' },
                { type: 'row3', fields: [
                    { name: 'city', label: 'City' },
                    { name: 'state', label: 'State' },
                    { name: 'zip', label: 'ZIP' }
                ]},
                { name: 'notes', label: 'Notes', type: 'textarea' }
            ];

            const getFieldsForTab = () => {
                switch (activeTab) {
                    case 'basic': return getBasicFields();
                    case 'pay': return getPayFields();
                    case 'cdl': return getCDLFields();
                    case 'medical': return getMedicalFields();
                    case 'background': return getBackgroundFields();
                    case 'training': return getTrainingFields();
                    case 'emergency': return getEmergencyFields();
                    case 'address': return getAddressFields();
                    default: return getBasicFields();
                }
            };

            const handleSave = async (formData) => {
                setLoading(true);
                try {
                    if (editItem) {
                        await api.request(`/data/drivers/${editItem.id}`, { method: 'PUT', body: JSON.stringify(formData) });
                    } else {
                        await api.request('/data/drivers', { method: 'POST', body: JSON.stringify(formData) });
                    }
                    setShowModal(false);
                    setEditItem(null);
                    onRefresh();
                } finally {
                    setLoading(false);
                }
            };

            const handleDelete = async (id) => {
                if (!confirm('Delete this driver?')) return;
                await api.request(`/data/drivers/${id}`, { method: 'DELETE' });
                onRefresh();
            };

            const tabs = [
                { id: 'basic', label: 'üë§ Basic' },
                { id: 'pay', label: 'üíµ Pay' },
                { id: 'cdl', label: 'ü™™ CDL' },
                { id: 'medical', label: 'üè• Medical' },
                { id: 'background', label: 'üîç Background' },
                { id: 'training', label: 'üìö Training' },
                { id: 'emergency', label: 'üö® Emergency' },
                { id: 'address', label: 'üìç Address' }
            ];

            const getExpirationStatus = (date) => {
                if (!date) return 'unknown';
                const d = new Date(date);
                const now = new Date();
                const days = Math.floor((d - now) / (1000 * 60 * 60 * 24));
                if (days < 0) return 'expired';
                if (days < 30) return 'critical';
                if (days < 60) return 'warning';
                return 'ok';
            };

            const StatusIndicator = ({ date, label }) => {
                const status = getExpirationStatus(date);
                const colors = { expired: '#EF4444', critical: '#F59E0B', warning: '#EAB308', ok: '#10B981', unknown: '#6B7280' };
                return (
                    <div style={{display:'flex',alignItems:'center',gap:'0.5rem'}}>
                        <span style={{width:'10px',height:'10px',borderRadius:'50%',background:colors[status]}}></span>
                        <span>{label}: {date || 'Not set'}</span>
                        {status === 'expired' && <span style={{color:colors.expired,fontWeight:'bold'}}>EXPIRED</span>}
                        {status === 'critical' && <span style={{color:colors.critical,fontWeight:'bold'}}>EXPIRING SOON</span>}
                    </div>
                );
            };

            // Driver Detail View
            if (viewItem) {
                return (
                    <>
                        <div className="page-header">
                            <h1 className="page-title">üë∑ {viewItem.name}</h1>
                            <div style={{display:'flex',gap:'0.5rem'}}>
                                <button className="btn btn-secondary" onClick={() => { setEditItem(viewItem); setViewItem(null); setShowModal(true); }}>Edit</button>
                                <button className="btn btn-secondary" onClick={() => setViewItem(null)}>‚Üê Back</button>
                            </div>
                        </div>
                        <div className="stats-grid">
                            <div className="stat-card">
                                <div className="stat-card-icon">üíµ</div>
                                <div className="stat-card-value">${viewItem.hourly_rate || 25}/hr</div>
                                <div className="stat-card-label">Hourly Rate</div>
                            </div>
                            <div className="stat-card">
                                <div className="stat-card-icon">üì¶</div>
                                <div className="stat-card-value">{viewItem.total_deliveries || 0}</div>
                                <div className="stat-card-label">Total Deliveries</div>
                            </div>
                            <div className="stat-card">
                                <div className="stat-card-icon">üõ£Ô∏è</div>
                                <div className="stat-card-value">{((viewItem.total_miles_driven || 0) / 1000).toFixed(1)}K</div>
                                <div className="stat-card-label">Miles Driven</div>
                            </div>
                            <div className="stat-card">
                                <div className="stat-card-icon">‚≠ê</div>
                                <div className="stat-card-value">{viewItem.on_time_delivery_rate || 100}%</div>
                                <div className="stat-card-label">On-Time Rate</div>
                            </div>
                        </div>
                        <div className="grid-2">
                            <div className="card">
                                <div className="card-header"><h3>ü™™ CDL Information</h3></div>
                                <div className="card-body">
                                    <div style={{display:'grid',gap:'0.75rem',fontSize:'0.9rem'}}>
                                        <div><strong>CDL Number:</strong> {viewItem.cdl_number || viewItem.license_number || '-'}</div>
                                        <div><strong>Class:</strong> {viewItem.cdl_class || '-'} | <strong>State:</strong> {viewItem.cdl_state || viewItem.license_state || '-'}</div>
                                        <StatusIndicator date={viewItem.license_expiry} label="CDL Expires" />
                                        <div><strong>Endorsements:</strong> {viewItem.cdl_endorsements || '-'}</div>
                                        <div><strong>HAZMAT:</strong> {viewItem.hazmat_endorsed || viewItem.hazmat_certified ? '‚úÖ Yes' : '‚ùå No'}</div>
                                        {(viewItem.hazmat_endorsed || viewItem.hazmat_certified) && <StatusIndicator date={viewItem.hazmat_expiration} label="HAZMAT Expires" />}
                                        <div><strong>Tanker:</strong> {viewItem.tanker_endorsed ? '‚úÖ Yes' : '‚ùå No'}</div>
                                        <div><strong>TWIC Card:</strong> {viewItem.twic_card ? '‚úÖ Yes' : '‚ùå No'}</div>
                                    </div>
                                </div>
                            </div>
                            <div className="card">
                                <div className="card-header"><h3>üè• Medical & Compliance</h3></div>
                                <div className="card-body">
                                    <div style={{display:'grid',gap:'0.75rem',fontSize:'0.9rem'}}>
                                        <StatusIndicator date={viewItem.medical_card_expiration} label="Medical Card" />
                                        <div><strong>Last Exam:</strong> {viewItem.medical_exam_date || '-'}</div>
                                        <div><strong>Examiner:</strong> {viewItem.medical_examiner_name || '-'}</div>
                                        <hr style={{border:'none',borderTop:'1px solid var(--border)'}} />
                                        <div><strong>Background:</strong> <span className={`status-badge status-${viewItem.background_check_status || 'pending'}`}>{viewItem.background_check_status || 'pending'}</span></div>
                                        <div><strong>Background Date:</strong> {viewItem.background_check_date || '-'}</div>
                                        <div><strong>Drug Test:</strong> <span className={`status-badge status-${viewItem.drug_test_status === 'passed' ? 'active' : viewItem.drug_test_status || 'pending'}`}>{viewItem.drug_test_status || 'pending'}</span></div>
                                        <div><strong>Drug Test Date:</strong> {viewItem.drug_test_date || '-'}</div>
                                        <div><strong>MVR Check:</strong> {viewItem.mvr_check_date || '-'} - {viewItem.mvr_status || 'pending'}</div>
                                    </div>
                                </div>
                            </div>
                            <div className="card">
                                <div className="card-header"><h3>üìö Training & Certifications</h3></div>
                                <div className="card-body">
                                    <div style={{display:'grid',gap:'0.75rem',fontSize:'0.9rem'}}>
                                        <div><strong>Propane Certified:</strong> {viewItem.propane_certified ? '‚úÖ Yes' : '‚ùå No'}</div>
                                        {viewItem.propane_certified && <StatusIndicator date={viewItem.propane_cert_expiration} label="Propane Cert" />}
                                        <div><strong>Defensive Driving:</strong> {viewItem.defensive_driving_cert ? '‚úÖ Yes' : '‚ùå No'}</div>
                                        <div><strong>Smith System:</strong> {viewItem.smith_system_trained ? '‚úÖ Yes' : '‚ùå No'}</div>
                                        <div><strong>Years Experience:</strong> {viewItem.years_experience || 0}</div>
                                        <div><strong>Last Training:</strong> {viewItem.last_training_date || '-'}</div>
                                    </div>
                                </div>
                            </div>
                            <div className="card">
                                <div className="card-header"><h3>üìã Personal Info</h3></div>
                                <div className="card-body">
                                    <div style={{display:'grid',gap:'0.75rem',fontSize:'0.9rem'}}>
                                        <div><strong>Email:</strong> {viewItem.email || '-'}</div>
                                        <div><strong>Phone:</strong> {viewItem.phone || '-'}</div>
                                        <div><strong>Hire Date:</strong> {viewItem.hire_date || '-'}</div>
                                        <div><strong>DOB:</strong> {viewItem.date_of_birth || '-'}</div>
                                        <hr style={{border:'none',borderTop:'1px solid var(--border)'}} />
                                        <div><strong>Emergency Contact:</strong> {viewItem.emergency_contact_name || '-'}</div>
                                        <div><strong>Emergency Phone:</strong> {viewItem.emergency_contact_phone || '-'}</div>
                                        <div><strong>Relationship:</strong> {viewItem.emergency_contact_relation || '-'}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </>
                );
            }

            return (
                <>
                    <div className="page-header">
                        <h1 className="page-title">üë∑ Drivers</h1>
                        <button className="btn btn-primary" onClick={() => { setEditItem(null); setActiveTab('basic'); setShowModal(true); }}>+ Add Driver</button>
                    </div>
                    <div className="table-container">
                        <table>
                            <thead><tr><th>Code</th><th>Name</th><th>CDL</th><th>HAZMAT</th><th>Rate</th><th>CDL Exp</th><th>Med Card</th><th>Status</th><th>Actions</th></tr></thead>
                            <tbody>
                                {(data?.drivers || []).map(item => (
                                    <tr key={item.id}>
                                        <td><strong style={{cursor:'pointer',color:'var(--primary)'}} onClick={() => setViewItem(item)}>{item.code}</strong></td>
                                        <td>{item.name}</td>
                                        <td>{item.cdl_class || '-'}</td>
                                        <td>{(item.hazmat_endorsed || item.hazmat_certified) ? '‚úÖ' : '‚ùå'}</td>
                                        <td>${item.hourly_rate || 25}/hr</td>
                                        <td><span style={{color: getExpirationStatus(item.license_expiry) === 'expired' ? 'var(--danger)' : getExpirationStatus(item.license_expiry) === 'critical' ? 'var(--warning)' : 'inherit'}}>{item.license_expiry || '-'}</span></td>
                                        <td><span style={{color: getExpirationStatus(item.medical_card_expiration) === 'expired' ? 'var(--danger)' : getExpirationStatus(item.medical_card_expiration) === 'critical' ? 'var(--warning)' : 'inherit'}}>{item.medical_card_expiration || '-'}</span></td>
                                        <td><span className={`status-badge status-${item.status}`}>{item.status}</span></td>
                                        <td>
                                            <div className="action-buttons">
                                                <button className="btn btn-sm btn-secondary" onClick={() => setViewItem(item)}>View</button>
                                                <button className="btn btn-sm btn-secondary" onClick={() => { setEditItem(item); setActiveTab('basic'); setShowModal(true); }}>Edit</button>
                                                <button className="btn btn-sm btn-danger" onClick={() => handleDelete(item.id)}>Delete</button>
                                            </div>
                                        </td>
                                    </tr>
                                ))}
                                {(!data?.drivers || data.drivers.length === 0) && (
                                    <tr><td colSpan="9" className="empty-state">No drivers yet. Click "Add Driver" to create one.</td></tr>
                                )}
                            </tbody>
                        </table>
                    </div>
                    {showModal && (
                        <DriverFormModal
                            editItem={editItem}
                            activeTab={activeTab}
                            setActiveTab={setActiveTab}
                            tabs={tabs}
                            getFieldsForTab={getFieldsForTab}
                            onSave={handleSave}
                            onClose={() => { setShowModal(false); setEditItem(null); }}
                            loading={loading}
                        />
                    )}
                </>
            );
        }

        // Driver Form Modal with stable state management
        function DriverFormModal({ editItem, activeTab, setActiveTab, tabs, getFieldsForTab, onSave, onClose, loading }) {
            const defaultData = { status: 'active', pay_type: 'hourly', hourly_rate: 25, background_check_status: 'pending', drug_test_status: 'pending', mvr_status: 'pending' };
            const [formData, setFormData] = useState(() => editItem ? { ...editItem } : { ...defaultData });
            const [error, setError] = useState('');

            const handleFieldChange = (name, value) => {
                setFormData(prev => ({ ...prev, [name]: value }));
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                setError('');
                try {
                    await onSave(formData);
                } catch (err) {
                    setError(err.message);
                }
            };

            const renderFields = () => {
                const fields = getFieldsForTab();
                return fields.map((field, index) => {
                    if (field.type === 'row') {
                        return (
                            <div key={`row-${index}`} className="form-row">
                                {field.fields.map(f => (
                                    <FormInput key={f.name} name={f.name} label={f.label} type={f.type} value={formData[f.name]} onChange={handleFieldChange} required={f.required} placeholder={f.placeholder} step={f.step} options={f.options} />
                                ))}
                            </div>
                        );
                    }
                    if (field.type === 'row3') {
                        return (
                            <div key={`row3-${index}`} className="form-row-3">
                                {field.fields.map(f => (
                                    <FormInput key={f.name} name={f.name} label={f.label} type={f.type} value={formData[f.name]} onChange={handleFieldChange} required={f.required} placeholder={f.placeholder} step={f.step} options={f.options} />
                                ))}
                            </div>
                        );
                    }
                    return <FormInput key={field.name} name={field.name} label={field.label} type={field.type} value={formData[field.name]} onChange={handleFieldChange} required={field.required} placeholder={field.placeholder} step={field.step} options={field.options} />;
                });
            };

            return (
                <div className="modal-overlay" onClick={(e) => e.target === e.currentTarget && onClose()}>
                    <div className="modal" style={{maxWidth:'1100px',width:'95%',display:'flex',flexDirection:'column',maxHeight:'90vh'}}>
                        <div className="modal-header" style={{flexShrink:0}}>
                            <h3>{editItem ? 'Edit Driver' : 'Add Driver'}</h3>
                            <button className="modal-close" onClick={onClose}>&times;</button>
                        </div>
                        <div style={{padding:'0 1rem',borderBottom:'1px solid var(--border)',display:'flex',gap:'0.25rem',flexWrap:'nowrap',flexShrink:0}}>
                            {tabs.map(tab => (
                                <button key={tab.id} className={`btn btn-sm ${activeTab === tab.id ? 'btn-primary' : 'btn-secondary'}`} style={{borderRadius:'8px 8px 0 0',whiteSpace:'nowrap',fontSize:'0.8rem',padding:'0.5rem 0.75rem'}} onClick={() => setActiveTab(tab.id)}>
                                    {tab.label}
                                </button>
                            ))}
                        </div>
                        <form onSubmit={handleSubmit} style={{display:'flex',flexDirection:'column',flex:1,overflow:'hidden'}}>
                            <div className="modal-body" style={{flex:1,overflowY:'auto',minHeight:'400px'}}>
                                {error && <div className="error-message">{error}</div>}
                                {renderFields()}
                            </div>
                            <div className="modal-footer" style={{flexShrink:0}}>
                                <button type="button" className="btn btn-secondary" onClick={onClose}>Cancel</button>
                                <button type="submit" className="btn btn-primary" disabled={loading}>{loading ? 'Saving...' : 'Save'}</button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }

        // =====================================================
        // DISTRIBUTION CENTERS VIEW
        // =====================================================
        function DCsView({ data, onRefresh }) {
            const [showModal, setShowModal] = useState(false);
            const [editItem, setEditItem] = useState(null);
            const [loading, setLoading] = useState(false);

            const fields = [
                { type: 'row', fields: [
                    { name: 'code', label: 'DC Code', required: true, placeholder: 'DC-001' },
                    { name: 'name', label: 'DC Name', required: true }
                ]},
                { name: 'address', label: 'Address' },
                { type: 'row3', fields: [
                    { name: 'city', label: 'City' },
                    { name: 'state', label: 'State' },
                    { name: 'zip', label: 'ZIP' }
                ]},
                { name: 'phone', label: 'Phone' },
                { type: 'row', fields: [
                    { name: 'lat', label: 'Latitude', type: 'number', step: '0.000001', placeholder: '34.730369' },
                    { name: 'lng', label: 'Longitude', type: 'number', step: '0.000001', placeholder: '-86.586104' }
                ]},
                { type: 'row', fields: [
                    { name: 'manager_name', label: 'Manager Name' },
                    { name: 'capacity_gallons', label: 'Capacity (gallons)', type: 'number' }
                ]},
                { name: 'status', label: 'Status', type: 'select', options: [
                    { value: 'active', label: 'Active' },
                    { value: 'inactive', label: 'Inactive' }
                ]}
            ];

            const handleSave = async (formData) => {
                setLoading(true);
                try {
                    if (editItem) {
                        await api.request(`/data/distribution-centers/${editItem.id}`, { method: 'PUT', body: JSON.stringify(formData) });
                    } else {
                        await api.request('/data/distribution-centers', { method: 'POST', body: JSON.stringify(formData) });
                    }
                    setShowModal(false);
                    setEditItem(null);
                    onRefresh();
                } finally {
                    setLoading(false);
                }
            };

            const handleDelete = async (id) => {
                if (!confirm('Delete this distribution center? This may affect trucks, drivers, and orders assigned to it.')) return;
                await api.request(`/data/distribution-centers/${id}`, { method: 'DELETE' });
                onRefresh();
            };

            return (
                <>
                    <div className="page-header">
                        <h1 className="page-title">üè≠ Distribution Centers</h1>
                        <button className="btn btn-primary" onClick={() => { setEditItem(null); setShowModal(true); }}>+ Add DC</button>
                    </div>
                    <div className="table-container">
                        <table>
                            <thead><tr><th>Code</th><th>Name</th><th>City</th><th>Manager</th><th>Capacity</th><th>Status</th><th>Actions</th></tr></thead>
                            <tbody>
                                {(data?.distributionCenters || []).map(item => (
                                    <tr key={item.id}>
                                        <td><strong>{item.code}</strong></td>
                                        <td>{item.name}</td>
                                        <td>{item.city}, {item.state}</td>
                                        <td>{item.manager_name || '-'}</td>
                                        <td>{(item.capacity_gallons || 0).toLocaleString()} gal</td>
                                        <td><span className={`status-badge status-${item.status}`}>{item.status}</span></td>
                                        <td>
                                            <div className="action-buttons">
                                                <button className="btn btn-sm btn-secondary" onClick={() => { setEditItem(item); setShowModal(true); }}>Edit</button>
                                                <button className="btn btn-sm btn-danger" onClick={() => handleDelete(item.id)}>Delete</button>
                                            </div>
                                        </td>
                                    </tr>
                                ))}
                                {(!data?.distributionCenters || data.distributionCenters.length === 0) && (
                                    <tr><td colSpan="7" className="empty-state">No distribution centers yet. Click "Add DC" to create one.</td></tr>
                                )}
                            </tbody>
                        </table>
                    </div>
                    {showModal && (
                        <EntityModal 
                            title={editItem ? 'Edit Distribution Center' : 'Add Distribution Center'}
                            fields={fields}
                            data={editItem || { status: 'active', capacity_gallons: 50000 }}
                            onSave={handleSave}
                            onClose={() => { setShowModal(false); setEditItem(null); }}
                            loading={loading}
                        />
                    )}
                </>
            );
        }

        // =====================================================
        // USERS VIEW (Admin Only)
        // =====================================================
        function UsersView({ data, onRefresh }) {
            const [showModal, setShowModal] = useState(false);
            const [editItem, setEditItem] = useState(null);
            const [loading, setLoading] = useState(false);
            const [users, setUsers] = useState([]);

            useEffect(() => { loadUsers(); }, []);

            const loadUsers = async () => {
                try {
                    const result = await api.request('/data/users');
                    setUsers(result);
                } catch (err) {
                    console.error('Failed to load users:', err);
                }
            };

            const dcOptions = (data?.distributionCenters || []).map(dc => ({ value: dc.id, label: dc.name }));
            const driverOptions = (data?.drivers || []).map(d => ({ value: d.id, label: `${d.code} - ${d.name}` }));

            const fields = [
                { type: 'row', fields: [
                    { name: 'username', label: 'Username', required: true },
                    { name: 'name', label: 'Full Name', required: true }
                ]},
                { type: 'row', fields: [
                    { name: 'email', label: 'Email', type: 'email', required: true },
                    { name: 'phone', label: 'Phone' }
                ]},
                { name: 'password', label: editItem ? 'New Password (leave blank to keep current)' : 'Password', type: 'password', required: !editItem },
                { type: 'row', fields: [
                    { name: 'role', label: 'Role', type: 'select', required: true, options: [
                        { value: 'admin', label: 'Admin' },
                        { value: 'dispatch', label: 'Dispatch' },
                        { value: 'driver', label: 'Driver' },
                        { value: 'accounting', label: 'Accounting' },
                        { value: 'payroll', label: 'Payroll' }
                    ]},
                    { name: 'status', label: 'Status', type: 'select', options: [
                        { value: 'active', label: 'Active' },
                        { value: 'inactive', label: 'Inactive' },
                        { value: 'suspended', label: 'Suspended' }
                    ]}
                ]},
                { type: 'row', fields: [
                    { name: 'dc_id', label: 'Assigned DC', type: 'select', options: dcOptions },
                    { name: 'driver_id', label: 'Link to Driver', type: 'select', options: driverOptions }
                ]}
            ];

            const handleSave = async (formData) => {
                setLoading(true);
                try {
                    if (editItem) {
                        await api.request(`/data/users/${editItem.id}`, { method: 'PUT', body: JSON.stringify(formData) });
                    } else {
                        await api.request('/data/users', { method: 'POST', body: JSON.stringify(formData) });
                    }
                    setShowModal(false);
                    setEditItem(null);
                    loadUsers();
                } finally {
                    setLoading(false);
                }
            };

            const handleDelete = async (id) => {
                if (!confirm('Delete this user?')) return;
                await api.request(`/data/users/${id}`, { method: 'DELETE' });
                loadUsers();
            };

            return (
                <>
                    <div className="page-header">
                        <h1 className="page-title">üë§ Users</h1>
                        <button className="btn btn-primary" onClick={() => { setEditItem(null); setShowModal(true); }}>+ Add User</button>
                    </div>
                    <div className="table-container">
                        <table>
                            <thead><tr><th>Username</th><th>Name</th><th>Email</th><th>Role</th><th>Status</th><th>Actions</th></tr></thead>
                            <tbody>
                                {users.map(item => (
                                    <tr key={item.id}>
                                        <td><strong>{item.username}</strong></td>
                                        <td>{item.name}</td>
                                        <td>{item.email}</td>
                                        <td style={{textTransform:'capitalize'}}>{item.role}</td>
                                        <td><span className={`status-badge status-${item.status}`}>{item.status}</span></td>
                                        <td>
                                            <div className="action-buttons">
                                                <button className="btn btn-sm btn-secondary" onClick={() => { setEditItem(item); setShowModal(true); }}>Edit</button>
                                                <button className="btn btn-sm btn-danger" onClick={() => handleDelete(item.id)}>Delete</button>
                                            </div>
                                        </td>
                                    </tr>
                                ))}
                                {users.length === 0 && (
                                    <tr><td colSpan="6" className="empty-state">No users found.</td></tr>
                                )}
                            </tbody>
                        </table>
                    </div>
                    {showModal && (
                        <EntityModal 
                            title={editItem ? 'Edit User' : 'Add User'}
                            fields={fields}
                            data={editItem || { status: 'active', role: 'dispatch' }}
                            onSave={handleSave}
                            onClose={() => { setShowModal(false); setEditItem(null); }}
                            loading={loading}
                        />
                    )}
                </>
            );
        }

        // =====================================================
        // BILLING VIEW - Full Implementation with Stripe
        // =====================================================
        function BillingView() {
            const [billing, setBilling] = useState(null);
            const [invoices, setInvoices] = useState([]);
            const [paymentMethod, setPaymentMethod] = useState(null);
            const [loading, setLoading] = useState(true);
            const [showAddCard, setShowAddCard] = useState(false);
            const [activeTab, setActiveTab] = useState('overview');
            const [message, setMessage] = useState(null);

            useEffect(() => { 
                loadBilling(); 
                loadInvoices();
                loadPaymentMethod();
            }, []);

            const loadBilling = async () => {
                try {
                    const data = await api.request('/tenant-billing');
                    setBilling(data);
                } catch (err) {
                    console.error('Failed to load billing:', err);
                } finally {
                    setLoading(false);
                }
            };

            const loadInvoices = async () => {
                try {
                    const data = await api.request('/tenant-billing/invoices');
                    setInvoices(data.invoices || []);
                } catch (err) {
                    console.error('Failed to load invoices:', err);
                }
            };

            const loadPaymentMethod = async () => {
                try {
                    const data = await api.request('/tenant-billing/payment-method');
                    setPaymentMethod(data);
                } catch (err) {
                    console.error('Failed to load payment method:', err);
                }
            };

            const handleToggleAutoPay = async () => {
                try {
                    const newState = !billing?.auto_pay;
                    await api.request('/tenant-billing/enable-autopay', {
                        method: 'POST',
                        body: JSON.stringify({ enabled: newState })
                    });
                    setMessage({ type: 'success', text: newState ? 'Auto-pay enabled' : 'Auto-pay disabled' });
                    loadBilling();
                } catch (err) {
                    setMessage({ type: 'error', text: err.message });
                }
            };

            const handleRemoveCard = async () => {
                if (!confirm('Remove this payment method?')) return;
                try {
                    await api.request('/tenant-billing/payment-method', { method: 'DELETE' });
                    setMessage({ type: 'success', text: 'Payment method removed' });
                    setPaymentMethod(null);
                    loadBilling();
                } catch (err) {
                    setMessage({ type: 'error', text: err.message });
                }
            };

            const handlePayInvoice = async (invoiceId) => {
                if (!paymentMethod?.has_payment_method) {
                    setMessage({ type: 'error', text: 'Please add a payment method first' });
                    setActiveTab('payment');
                    return;
                }
                try {
                    await api.request(`/tenant-billing/pay/${invoiceId}`, { method: 'POST' });
                    setMessage({ type: 'success', text: 'Payment successful!' });
                    loadBilling();
                    loadInvoices();
                } catch (err) {
                    setMessage({ type: 'error', text: err.message });
                }
            };

            const handleCardSaved = () => {
                setShowAddCard(false);
                setMessage({ type: 'success', text: 'Payment method saved!' });
                loadPaymentMethod();
                loadBilling();
            };

            if (loading) return <div className="loading"><div className="spinner"></div></div>;

            const tabs = [
                { id: 'overview', label: 'üìä Overview' },
                { id: 'invoices', label: 'üìÑ Invoices' },
                { id: 'payment', label: 'üí≥ Payment Method' }
            ];

            return (
                <>
                    <div className="page-header"><h1 className="page-title">üí≥ Billing</h1></div>
                    
                    {message && (
                        <div className={message.type === 'success' ? 'success-message' : 'error-message'} style={{marginBottom:'1rem'}}>
                            {message.text}
                            <button onClick={() => setMessage(null)} style={{float:'right',background:'none',border:'none',cursor:'pointer',color:'inherit'}}>‚úï</button>
                        </div>
                    )}

                    {/* Stats */}
                    <div className="stats-grid">
                        <div className="stat-card">
                            <div className="stat-card-icon">üìã</div>
                            <div className="stat-card-value" style={{textTransform:'capitalize'}}>{billing?.company?.plan || 'Trial'}</div>
                            <div className="stat-card-label">Current Plan</div>
                        </div>
                        <div className="stat-card">
                            <div className="stat-card-icon">üí∞</div>
                            <div className="stat-card-value">${billing?.company?.monthly_price || 0}/mo</div>
                            <div className="stat-card-label">Monthly Rate</div>
                        </div>
                        <div className="stat-card">
                            <div className="stat-card-icon">{(billing?.balance || 0) > 0 ? '‚ö†Ô∏è' : '‚úÖ'}</div>
                            <div className="stat-card-value" style={{color: (billing?.balance || 0) > 0 ? 'var(--danger)' : 'var(--success)'}}>${(billing?.balance || 0).toFixed(2)}</div>
                            <div className="stat-card-label">Account Balance</div>
                        </div>
                        <div className="stat-card">
                            <div className="stat-card-icon">{billing?.auto_pay ? 'üîÑ' : '‚è∏Ô∏è'}</div>
                            <div className="stat-card-value">{billing?.auto_pay ? 'Active' : 'Off'}</div>
                            <div className="stat-card-label">Auto-Pay</div>
                        </div>
                    </div>

                    {/* Tabs */}
                    <div style={{display:'flex',gap:'0.5rem',marginBottom:'1.5rem',borderBottom:'1px solid var(--border)',paddingBottom:'0.5rem'}}>
                        {tabs.map(tab => (
                            <button 
                                key={tab.id}
                                className={`btn ${activeTab === tab.id ? 'btn-primary' : 'btn-secondary'}`}
                                onClick={() => setActiveTab(tab.id)}
                                style={{borderRadius:'8px 8px 0 0'}}
                            >
                                {tab.label}
                            </button>
                        ))}
                    </div>

                    {/* Overview Tab */}
                    {activeTab === 'overview' && (
                        <div className="grid-2">
                            <div className="card">
                                <div className="card-header"><h3>üìÑ Recent Invoices</h3></div>
                                <div style={{maxHeight:'300px',overflow:'auto'}}>
                                    <table>
                                        <thead><tr><th>Invoice</th><th>Date</th><th>Amount</th><th>Status</th></tr></thead>
                                        <tbody>
                                            {invoices.slice(0, 5).map(inv => (
                                                <tr key={inv.id}>
                                                    <td><strong>{inv.invoice_number}</strong></td>
                                                    <td>{new Date(inv.created_at).toLocaleDateString()}</td>
                                                    <td>${parseFloat(inv.total).toFixed(2)}</td>
                                                    <td><span className={`status-badge status-${inv.status}`}>{inv.status}</span></td>
                                                </tr>
                                            ))}
                                            {invoices.length === 0 && <tr><td colSpan="4" className="text-muted" style={{textAlign:'center',padding:'2rem'}}>No invoices yet</td></tr>}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div className="card">
                                <div className="card-header"><h3>üí≥ Payment Method</h3></div>
                                <div className="card-body">
                                    {paymentMethod?.has_payment_method ? (
                                        <div>
                                            <div style={{display:'flex',alignItems:'center',gap:'1rem',padding:'1rem',background:'var(--bg-dark)',borderRadius:'8px',marginBottom:'1rem'}}>
                                                <span style={{fontSize:'2rem'}}>üí≥</span>
                                                <div>
                                                    <div style={{fontWeight:'600',textTransform:'capitalize'}}>{paymentMethod.card?.brand} ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ {paymentMethod.card?.last4}</div>
                                                    <div className="text-muted">Expires {paymentMethod.card?.exp_month}/{paymentMethod.card?.exp_year}</div>
                                                </div>
                                            </div>
                                            <div style={{display:'flex',alignItems:'center',justifyContent:'space-between'}}>
                                                <label style={{display:'flex',alignItems:'center',gap:'0.5rem',cursor:'pointer'}}>
                                                    <input type="checkbox" checked={billing?.auto_pay || false} onChange={handleToggleAutoPay} style={{width:'18px',height:'18px'}} />
                                                    Auto-pay enabled
                                                </label>
                                                <button className="btn btn-sm btn-secondary" onClick={() => setActiveTab('payment')}>Manage</button>
                                            </div>
                                        </div>
                                    ) : (
                                        <div style={{textAlign:'center',padding:'1rem'}}>
                                            <p className="text-muted" style={{marginBottom:'1rem'}}>No payment method on file</p>
                                            <button className="btn btn-primary" onClick={() => { setActiveTab('payment'); setShowAddCard(true); }}>+ Add Payment Method</button>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Invoices Tab */}
                    {activeTab === 'invoices' && (
                        <div className="table-container">
                            <table>
                                <thead><tr><th>Invoice #</th><th>Date</th><th>Due Date</th><th>Amount</th><th>Status</th><th>Actions</th></tr></thead>
                                <tbody>
                                    {invoices.map(inv => (
                                        <tr key={inv.id}>
                                            <td><strong>{inv.invoice_number}</strong></td>
                                            <td>{new Date(inv.created_at).toLocaleDateString()}</td>
                                            <td>{inv.due_date ? new Date(inv.due_date).toLocaleDateString() : '-'}</td>
                                            <td>${parseFloat(inv.total).toFixed(2)}</td>
                                            <td><span className={`status-badge status-${inv.status}`}>{inv.status}</span></td>
                                            <td>
                                                {inv.status === 'pending' && (
                                                    <button className="btn btn-sm btn-success" onClick={() => handlePayInvoice(inv.id)}>Pay Now</button>
                                                )}
                                            </td>
                                        </tr>
                                    ))}
                                    {invoices.length === 0 && <tr><td colSpan="6" className="empty-state">No invoices found</td></tr>}
                                </tbody>
                            </table>
                        </div>
                    )}

                    {/* Payment Method Tab */}
                    {activeTab === 'payment' && (
                        <div className="card">
                            <div className="card-header">
                                <h3>üí≥ Payment Method</h3>
                                {!showAddCard && !paymentMethod?.has_payment_method && (
                                    <button className="btn btn-primary btn-sm" onClick={() => setShowAddCard(true)}>+ Add Card</button>
                                )}
                            </div>
                            <div className="card-body">
                                {showAddCard ? (
                                    <AddCardForm onSuccess={handleCardSaved} onCancel={() => setShowAddCard(false)} />
                                ) : paymentMethod?.has_payment_method ? (
                                    <div>
                                        <div style={{display:'flex',alignItems:'center',gap:'1rem',padding:'1.5rem',background:'var(--bg-dark)',borderRadius:'12px',marginBottom:'1.5rem'}}>
                                            <div style={{fontSize:'3rem'}}>üí≥</div>
                                            <div style={{flex:1}}>
                                                <div style={{fontSize:'1.25rem',fontWeight:'600',textTransform:'capitalize'}}>{paymentMethod.card?.brand} ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ {paymentMethod.card?.last4}</div>
                                                <div className="text-muted">Expires {paymentMethod.card?.exp_month}/{paymentMethod.card?.exp_year}</div>
                                            </div>
                                            <button className="btn btn-danger btn-sm" onClick={handleRemoveCard}>Remove</button>
                                        </div>
                                        <div style={{display:'flex',alignItems:'center',gap:'1rem',padding:'1rem',background:'var(--bg-dark)',borderRadius:'8px'}}>
                                            <label style={{display:'flex',alignItems:'center',gap:'0.75rem',cursor:'pointer',flex:1}}>
                                                <input type="checkbox" checked={billing?.auto_pay || false} onChange={handleToggleAutoPay} style={{width:'20px',height:'20px'}} />
                                                <div>
                                                    <div style={{fontWeight:'600'}}>Auto-Pay</div>
                                                    <div className="text-muted" style={{fontSize:'0.85rem'}}>Automatically pay invoices on due date</div>
                                                </div>
                                            </label>
                                        </div>
                                    </div>
                                ) : (
                                    <div style={{textAlign:'center',padding:'3rem'}}>
                                        <div style={{fontSize:'4rem',marginBottom:'1rem'}}>üí≥</div>
                                        <h3 style={{marginBottom:'0.5rem'}}>No Payment Method</h3>
                                        <p className="text-muted" style={{marginBottom:'1.5rem'}}>Add a credit or debit card to enable auto-pay and pay invoices online.</p>
                                        <button className="btn btn-primary" onClick={() => setShowAddCard(true)}>+ Add Payment Method</button>
                                    </div>
                                )}
                            </div>
                        </div>
                    )}
                </>
            );
        }

        // =====================================================
        // ADD CARD FORM - Stripe Elements
        // =====================================================
        function AddCardForm({ onSuccess, onCancel }) {
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');
            const [stripeReady, setStripeReady] = useState(false);
            const [cardComplete, setCardComplete] = useState(false);
            const stripeRef = useRef(null);
            const elementsRef = useRef(null);
            const cardRef = useRef(null);
            const cardElementRef = useRef(null);

            useEffect(() => {
                initStripe();
                return () => {
                    if (cardElementRef.current) {
                        cardElementRef.current.destroy();
                    }
                };
            }, []);

            const initStripe = async () => {
                try {
                    // Get Stripe config
                    const config = await api.request('/tenant-billing/stripe-config');
                    
                    if (!config.publishableKey) {
                        setError('Stripe is not configured. Please contact support.');
                        return;
                    }

                    // Initialize Stripe
                    const stripe = Stripe(config.publishableKey);
                    stripeRef.current = stripe;

                    // Create Elements
                    const elements = stripe.elements({
                        appearance: {
                            theme: 'night',
                            variables: {
                                colorPrimary: '#6366F1',
                                colorBackground: '#0F172A',
                                colorText: '#F8FAFC',
                                colorDanger: '#EF4444',
                                fontFamily: 'Outfit, system-ui, sans-serif',
                                borderRadius: '8px'
                            }
                        }
                    });
                    elementsRef.current = elements;

                    // Create card element
                    const cardElement = elements.create('card', {
                        style: {
                            base: {
                                fontSize: '16px',
                                color: '#F8FAFC',
                                '::placeholder': { color: '#64748B' }
                            },
                            invalid: { color: '#EF4444' }
                        }
                    });

                    // Mount card element
                    if (cardRef.current) {
                        cardElement.mount(cardRef.current);
                        cardElementRef.current = cardElement;

                        cardElement.on('change', (event) => {
                            setCardComplete(event.complete);
                            if (event.error) {
                                setError(event.error.message);
                            } else {
                                setError('');
                            }
                        });

                        cardElement.on('ready', () => {
                            setStripeReady(true);
                        });
                    }
                } catch (err) {
                    console.error('Stripe init error:', err);
                    setError('Failed to initialize payment form: ' + err.message);
                }
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!stripeRef.current || !cardElementRef.current) {
                    setError('Payment form not ready');
                    return;
                }

                setLoading(true);
                setError('');

                try {
                    // Create SetupIntent
                    const setupData = await api.request('/tenant-billing/setup-intent', { method: 'POST' });

                    if (!setupData.client_secret) {
                        throw new Error('Failed to create setup intent');
                    }

                    // Confirm card setup
                    const { setupIntent, error: stripeError } = await stripeRef.current.confirmCardSetup(
                        setupData.client_secret,
                        { payment_method: { card: cardElementRef.current } }
                    );

                    if (stripeError) {
                        throw new Error(stripeError.message);
                    }

                    if (setupIntent.status !== 'succeeded') {
                        throw new Error('Card setup failed: ' + setupIntent.status);
                    }

                    // Save payment method to our backend
                    await api.request('/tenant-billing/save-payment-method', {
                        method: 'POST',
                        body: JSON.stringify({ payment_method_id: setupIntent.payment_method })
                    });

                    onSuccess();
                } catch (err) {
                    console.error('Payment error:', err);
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <form onSubmit={handleSubmit}>
                    {error && <div className="error-message" style={{marginBottom:'1rem'}}>{error}</div>}
                    
                    <div style={{marginBottom:'1.5rem'}}>
                        <label className="form-label">Card Details</label>
                        <div 
                            ref={cardRef}
                            style={{
                                padding: '1rem',
                                background: 'var(--bg-dark)',
                                border: '2px solid var(--border)',
                                borderRadius: '8px',
                                minHeight: '50px'
                            }}
                        >
                            {!stripeReady && <span className="text-muted">Loading payment form...</span>}
                        </div>
                    </div>

                    <div style={{background:'var(--bg-dark)',padding:'1rem',borderRadius:'8px',marginBottom:'1.5rem'}}>
                        <div style={{fontSize:'0.85rem',color:'var(--text-muted)'}}>
                            <strong>Test Cards:</strong><br/>
                            ‚úÖ Success: 4242 4242 4242 4242<br/>
                            ‚ùå Decline: 4000 0000 0000 0002<br/>
                            Use any future expiry, any CVC, any ZIP
                        </div>
                    </div>

                    <div style={{display:'flex',gap:'1rem',justifyContent:'flex-end'}}>
                        <button type="button" className="btn btn-secondary" onClick={onCancel} disabled={loading}>Cancel</button>
                        <button type="submit" className="btn btn-primary" disabled={loading || !stripeReady || !cardComplete}>
                            {loading ? 'Saving...' : 'üí≥ Save Card'}
                        </button>
                    </div>

                    <p style={{marginTop:'1rem',fontSize:'0.85rem',color:'var(--text-muted)',textAlign:'center'}}>
                        üîí Your card details are securely processed by Stripe
                    </p>
                </form>
            );
        }

        // =====================================================
        // Main App Component
        // =====================================================
        function App() {
            const [user, setUser] = useState(null);
            const [company, setCompany] = useState(null);
            const tenant = getTenant();

            useEffect(() => {
                api.setTenant(tenant);
                // Check both 'token' (from portal login) and 'authToken' (from app login)
                const token = localStorage.getItem('token') || localStorage.getItem('authToken');
                const savedUser = localStorage.getItem('user');
                const savedCompany = localStorage.getItem('company');
                
                try {
                    if (token && savedUser && savedCompany) {
                        const parsedUser = JSON.parse(savedUser);
                        const parsedCompany = JSON.parse(savedCompany);
                        if (parsedUser?.id && parsedUser?.name && parsedCompany?.id && parsedCompany?.name) {
                            api.setToken(token);
                            setUser(parsedUser);
                            setCompany(parsedCompany);
                        } else {
                            clearAuth();
                        }
                    }
                } catch (err) {
                    clearAuth();
                }
            }, []);

            const clearAuth = () => {
                // Clear both token keys for complete logout
                localStorage.removeItem('token');
                localStorage.removeItem('authToken');
                localStorage.removeItem('user');
                localStorage.removeItem('company');
            };

            const handleLogin = (data) => {
                if (data?.user && data?.company) {
                    setUser(data.user);
                    setCompany(data.company);
                    localStorage.setItem('user', JSON.stringify(data.user));
                    localStorage.setItem('company', JSON.stringify(data.company));
                }
            };

            const handleLogout = () => {
                api.setToken(null);
                clearAuth();
                setUser(null);
                setCompany(null);
            };

            if (!user || !company) return <LoginScreen onLogin={handleLogin} tenant={tenant} />;
            return <MainDashboard user={user} company={company} onLogout={handleLogout} />;
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
